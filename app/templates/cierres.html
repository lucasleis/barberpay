{% extends "layout.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='cierre_entre_dias.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='services.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<h3>Cierres</h3>
<form id="form-fechas" class="form-fechas">
  <label for="fechaInicio">Seleccionar fecha:</label>

  <div class="rango-fechas">
    <label for="fechaInicio">Desde</label>
    <input type="date" name="fechaInicio" id="fechaInicio" value="{{ request.args.get('fechaInicio', fechaInicio) }}">

    <label for="fechaFinal">Hasta</label>
    <input type="date" name="fechaFinal" id="fechaFinal" value="{{ request.args.get('fechaFinal', fechaFinal) }}">

    <button type="submit" class="boton-cierre">Ver cierre</button>
  </div>

</form>

<div id="editPaymentModal" class="modal-cantidad">
  <div class="modal-content">
    <h3>Editar Pago</h3>
    <span class="close-modal" onclick="closeEditModal()">&times;</span>

    <!-- FORMULARIO DE EDICIÓN -->
    <form id="editPaymentForm" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <!-- Fecha -->
      <div class="form-group">
        <label for="editDate">Fecha:</label>
        <input type="date" id="editDate" class="input-date-custom" required>
        <input type="hidden" id="editDateHidden" name="date">
      </div>

      <!-- Empleado -->
      <div class="form-group">
        <label for="editBarber">Empleado:</label>
        <select id="editBarber" name="barber_id" required>
          {% for b in barbers %}
            <option value="{{ b.id }}">{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Servicio -->
      <div class="form-group">
        <label for="editService">Servicio:</label>
        <select id="editService" name="service_id" required>
          {% for s in services %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Método de pago 1 -->
      <div class="form-group">
        <label for="editMethod1">Método de Pago 1:</label>
        <select id="editMethod1" name="method1" required>
          {% for m in methods %}
            <option value="{{ m.id }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="editAmount1">Monto 1:</label>
        <input type="number" id="editAmount1" name="amount1" step="0.01" required>
      </div>

      <!-- Método de pago 2 -->
      <div class="form-group">
        <label for="editMethod2">Método de Pago 2 (opcional):</label>
        <select id="editMethod2" name="method2">
          <option value="">-- Ninguno --</option>
          {% for m in methods %}
            <option value="{{ m.id }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="editAmount2">Monto 2:</label>
        <input type="number" id="editAmount2" name="amount2" step="0.01">
      </div>

      <!-- Propina -->
      <div class="form-group">
        <label for="editTip">Propina:</label>
        <input type="number" id="editTip" name="tip" step="0.01" required>
      </div>
    </form>

    <!-- BOTONES (afuera del form, pero al mismo nivel visual) -->
    <div class="edit-buttons-container" style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
      <!-- Botón Eliminar -->
      <form id="deletePaymentForm" method="POST" style="margin: 0;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-danger" title="Eliminar pago" style="padding: 8px 12px;">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </form>

      <!-- Botón Guardar -->
      <button type="submit" form="editPaymentForm" class="edit-button" style="flex-grow: 1;">
        <i class="fas fa-check"></i> Confirmar cambios
      </button>
    </div>

  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="confirmDeleteModal" class="modal-confirm">
  <div class="modal-confirm-content">
    <h3>¿Eliminar pago?</h3>
    <p>Esta acción no se puede deshacer.</p>
    <div class="modal-confirm-buttons">
      <button id="cancelDeleteBtn" class="btn btn-secondary">Cancelar</button>
      <button id="confirmDeleteBtn" class="btn btn-danger">Eliminar</button>
    </div>
  </div>
</div>


<div id="resultados-cierres">
  <!-- Aquí se renderizarán los resultados desde JavaScript -->
</div>

<script>
  document.getElementById('form-fechas').addEventListener('submit', async function (e) {
    e.preventDefault();

    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFinal = document.getElementById('fechaFinal').value;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const response = await fetch('/pagos_entre_fechas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        start_date: fechaInicio,
        end_date: fechaFinal
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error("Error en respuesta:", response.status, errorText);
      return;
    }

    const data = await response.json();
    window.lastPagos = data.pagos;
    renderCierres(data);
  });

  function renderCierres(data) {
    const contenedor = document.getElementById('resultados-cierres');
    contenedor.innerHTML = ''; // Limpia resultados anteriores

    if (!data.pagos.length) {
      contenedor.innerHTML = '<p>No se encontraron pagos en el rango seleccionado.</p>';
      return;
    }

    // Renderiza el resumen de cierres (puedes mejorar el diseño)
    let html = `
      <h4><strong>Resumen de pagos: </strong></h4>

      <h6 class="titulo-con-linea"><strong> - Totales por método de pago:</strong></h6>
      <p class="metodos-pago">
        ${Object.entries(data.totales.metodos_pago).map(([m, v]) =>
          `<strong>${m}</strong>: $${parseInt(v).toLocaleString('es-AR')}`
        ).join(' | ')}
      </p>
      <div class="linea-inferior"></div>


      <h6 class="titulo-con-linea"><strong> - Totales por empleado:</strong></h6>
      <div class="empleado-scroll-wrap">
        <div class="empleados-grid">
          <div class="empleado-header">Empleado</div>
          <div class="empleado-header">Total</div>
          <div class="empleado-header">Cortes</div>
          <div class="empleado-header">Productos</div>
          <div class="empleado-header">Propinas</div>

          ${Object.entries(data.totales.empleados).map(([nombre, datos]) => {
            const totalConPropinas = parseFloat(datos.monto) + parseFloat(datos.propinas || 0);
            const montoCortes = parseFloat(datos.monto_cortes || 0);
            const montoProductos = parseFloat(datos.monto_productos || 0);
            const cortes = parseInt(datos.cortes || 0);
            const productos = parseInt(datos.productos || 0);
            const propinas = parseFloat(datos.propinas || 0);

            return `
              <div class="empleado-celda">${nombre}</div>
              <div class="empleado-celda">$${totalConPropinas.toLocaleString('es-AR')}</div>
              <div class="empleado-celda">$${montoCortes.toLocaleString('es-AR')} (${cortes})</div>
              <div class="empleado-celda">$${montoProductos.toLocaleString('es-AR')} (${productos})</div>
              <div class="empleado-celda">$${propinas.toLocaleString('es-AR')}</div>
            `;
          }).join('')}
        </div>
      </div>

      <div class="linea-inferior"></div>

      <p><strong>Total de cortes:</strong> ${Object.values(data.totales.empleados).reduce((acc, emp) => acc + (parseInt(emp.cortes) || 0), 0)}</p>
      <div class="linea-inferior"></div>

      <p><strong>Total de productos vendidos:</strong> ${Object.values(data.totales.empleados).reduce((acc, emp) => acc + (parseInt(emp.productos) || 0), 0)}</p>
      <div class="linea-inferior"></div>

      {% if role == "admin" %}
        <p><strong>Total propietario:</strong> $${parseInt(data.totales.propietario_total).toLocaleString('es-AR')}</p>
        <div class="linea-inferior"></div>

        <p><strong>Total general:</strong> $${parseInt(data.totales.monto_total).toLocaleString('es-AR')}</p>
        <div class="linea-inferior"></div>
      {% endif %}

    `;

    // Tabla de pagos
    html += `

      <h4><strong>Pagos entre Fechas: </strong></h4>
      <table class="table table-striped table-bordered text-center" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Empleado</th>
            <th>% Empleado</th>
            <th>Servicio</th>
            <th>Valor Servicio</th>
            <th>Producto</th>
            <th>Valor Producto</th>
            <th>Membresia</th>
            <th>Valor Membresia</th>
            <th>M. de Pago</th>
            <th>Monto</th>
            <th>Propina</th>
            <th>$ Empleado</th>
            <th>$ Propietario</th>
            <th>Editar</th>
          </tr>
        </thead>
        <tbody>
          ${data.pagos.map(p => `
            <tr>
              <td>${p.fecha}</td>
              <td>${p.empleado}</td>
              <td>
                ${Array.isArray(p.porcentaje_empleado)
                  ? p.porcentaje_empleado.map(pct => pct + '%').join(' - ')
                  : p.porcentaje_empleado + '%'}
              </td>
              <td>${p.servicio || '-'}</td>
              <td>${p.valor_servicio === 0 ? '-' : '$' + parseInt(p.valor_servicio).toLocaleString('es-AR')}</td>
              <td>${p.producto && p.producto.length ? p.producto.join(' - ') : '-'}</td>
              <td>
                ${p.montos_productos && p.montos_productos.length
                  ? p.montos_productos.map(m => '$' + parseInt(m).toLocaleString('es-AR')).join(' - ')
                  : '-'}
              </td>
              <td>${p.membresia || '-'}</td>
              <td>${p.valor_membresia === 0 ? '-' : '$' + parseInt(p.valor_membresia).toLocaleString('es-AR')}</td>
              <td>${p.metodo_pago.join(' - ')}</td>
              <td>${p.metodos_pago_str}</td>
              <td>$${parseInt(p.propina).toLocaleString('es-AR')}</td>
              <td>$${parseInt(p.pago_empleado).toLocaleString('es-AR')}</td>
              <td>$${parseInt(p.pago_propietario).toLocaleString('es-AR')}</td>
              <td>
                <button
                  type="button"
                  class="edit-icon ${p.tipo_pago === 'servicio' ? 'enabled' : 'disabled'}"
                  title="${p.tipo_pago === 'servicio' ? 'Editar pago' : 'Solo se pueden editar pagos de servicios'}"
                  ${p.tipo_pago === 'servicio'
                    ? `onclick="openEditModal(${p.id}, '${p.fecha}', '${p.empleado}', '${p.metodo_pago.join(' - ')}', ${p.monto || 0}, ${p.propina || 0})"`
                    : 'disabled'}
                >
                  <i class="fas fa-pen"></i>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    contenedor.innerHTML = html;
  }

  // Simular el envío del formulario al cargar la página
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('form-fechas').dispatchEvent(new Event('submit'));
  });

  function openEditModal(id, fecha, empleado, metodo, monto, propina) {
    const modal = document.getElementById("editPaymentModal");
    const form = document.getElementById("editPaymentForm");

    // Buscar el pago en los datos renderizados (para obtener más info)
    const pago = window.lastPagos.find(p => p.id === id);
    if (!pago) return;

    form.action = `/pagos/editar/${id}`;
    modal.style.display = "flex";
    modal.offsetHeight;
    modal.classList.add("active");

    // ✅ Mostrar solo la fecha, pero luego se setea 23:59 al guardar
    if (pago.fecha_completa) {
      const fechaOriginal = new Date(pago.fecha_completa);
      const fechaLocal = fechaOriginal.toISOString().slice(0, 10); // solo yyyy-mm-dd
      document.getElementById("editDate").value = fechaLocal;
    } else {
      const hoy = new Date();
      const fechaLocal = hoy.toISOString().slice(0, 10);
      document.getElementById("editDate").value = fechaLocal;
    }

    // Empleado
    document.getElementById("editBarber").value = pago.empleado_id || "";

    // Servicio
    document.getElementById("editService").value = pago.service_id || "";

    // Método 1 / Monto 1
    document.getElementById("editMethod1").value = pago.method1_id || "";
    document.getElementById("editAmount1").value = pago.amount1 || 0;

    // Método 2 / Monto 2
    document.getElementById("editMethod2").value = pago.method2_id || "";
    document.getElementById("editAmount2").value = (pago.amount2 !== null && pago.amount2 !== undefined) ? pago.amount2 : 0;

    // Propina
    document.getElementById("editTip").value = pago.propina || 0;

    document.getElementById("deletePaymentForm").action = `/payments/delete/${id}`;
  }

  function closeEditModal() {
    const modal = document.getElementById("editPaymentModal");
    modal.classList.remove("active");
    setTimeout(() => {
      modal.style.display = "none";
    }, 300);
  }

  // Cerrar al click fuera
  window.onclick = function (event) {
    const modal = document.getElementById("editPaymentModal");
    if (event.target === modal) {
      closeEditModal();
    }
  };

  // --- VALIDACIONES DEL FORMULARIO DE EDICIÓN ---
  document.getElementById("editPaymentForm").addEventListener("submit", function (e) {
    e.preventDefault();

    let valid = true;
    const errores = [];

    const method1 = document.getElementById("editMethod1").value;
    const method2 = document.getElementById("editMethod2").value;
    const amount1 = parseFloat(document.getElementById("editAmount1").value || "0");
    const amount2 = parseFloat(document.getElementById("editAmount2").value || "0");
    const tip = parseFloat(document.getElementById("editTip").value || "0");

    // --- Validar duplicación de métodos ---
    if (method1 && method2 && method1 === method2) {
      errores.push("No puede elegir el mismo método de pago dos veces.");
      valid = false;
    }

    // --- Validar montos ---
    if (amount1 < 0 || amount2 < 0 || tip < 0) {
      errores.push("Los montos y la propina no pueden ser negativos.");
      valid = false;
    }

    // --- Validar que haya al menos un monto válido ---
    if (amount1 === 0 && amount2 === 0) {
      errores.push("Debe ingresar al menos un monto válido en alguno de los métodos de pago.");
      valid = false;
    }

    // --- Validar empleado ---
    const barber = document.getElementById("editBarber").value;
    if (!barber) {
      errores.push("Debe seleccionar un empleado.");
      valid = false;
    }

    // --- Validar servicio ---
    const service = document.getElementById("editService").value;
    if (!service) {
      errores.push("Debe seleccionar un servicio.");
      valid = false;
    }

    // --- Mostrar errores si hay ---
    const existingError = document.getElementById("editFormError");
    if (existingError) existingError.remove();

    if (!valid) {
      const errorBox = document.createElement("div");
      errorBox.id = "editFormError";
      errorBox.style.color = "red";
      errorBox.style.marginTop = "10px";
      errorBox.style.fontSize = "0.9rem";
      errorBox.innerHTML = errores.map(e => `• ${e}`).join("<br>");
      document.querySelector("#editPaymentForm .edit-button").insertAdjacentElement("beforebegin", errorBox);
      return;
    }

    // --- Si todo está bien, forzar hora 23:59 y enviar ---
    const inputFecha = document.getElementById("editDate");
    const inputHidden = document.getElementById("editDateHidden");
    if (inputFecha && inputFecha.value) {
      const fechaEditada = new Date(inputFecha.value);
      fechaEditada.setHours(23, 59, 0, 0);
      inputHidden.value = fechaEditada.toISOString().slice(0, 16);
    }
    e.target.submit();
  });

  document.getElementById("editService").addEventListener("change", function() {
    const selected = this.options[this.selectedIndex];
    const price = selected.getAttribute("data-precio");
    document.getElementById("editServicePrice").value = price ? `$${price}` : "";
  });

  // Abrir modal de confirmación
  document.getElementById("deletePaymentForm").addEventListener("submit", function(e) {
    e.preventDefault(); // prevenir envío inmediato
    document.getElementById("confirmDeleteModal").classList.add("active");
  });

  // Botón cancelar
  document.getElementById("cancelDeleteBtn").addEventListener("click", function() {
    document.getElementById("confirmDeleteModal").classList.remove("active");
  });

  // Botón confirmar
  document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
    document.getElementById("confirmDeleteModal").classList.remove("active");
    document.getElementById("deletePaymentForm").submit(); // envía el formulario real
  });


</script>

{% endblock %}
