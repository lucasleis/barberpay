{% extends "layout.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='cierre_entre_dias.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='services.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<h3>Cierres</h3>
<form id="form-fechas" class="form-fechas">
  <label for="fechaInicio">Seleccionar fecha:</label>

  <div class="rango-fechas">
    <label for="fechaInicio">Desde</label>
    <input type="date" name="fechaInicio" id="fechaInicio" value="{{ request.args.get('fechaInicio', fechaInicio) }}">

    <label for="fechaFinal">Hasta</label>
    <input type="date" name="fechaFinal" id="fechaFinal" value="{{ request.args.get('fechaFinal', fechaFinal) }}">

    <button type="submit" class="boton-cierre">Ver cierre</button>
  </div>

</form>

<div id="editPaymentModal" class="modal-cantidad">
  <div class="modal-content" id="editPaymentModalContent">
    <h3>Editar Pago</h3>
    <span class="close-modal" onclick="closeEditModal()">&times;</span>

    <!-- Contenedor de mensajes de error -->
    <div class="error-wrapper">
      <div id="editFormErrorContainer"></div>
    </div>

    <!-- FORMULARIO DE EDICI√ìN -->
    <form id="editPaymentForm" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <!-- Fecha -->
      <div class="form-group">
        <label for="editDate">Fecha:</label>
        <input type="date" id="editDate" class="input-date-custom" required>
        <input type="hidden" id="editDateHidden" name="date">
      </div>

      <!-- Empleado -->
      <div class="form-group">
        <label for="editBarber">Empleado:</label>
        <select id="editBarber" name="barber_id" required>
          {% for b in barbers %}
            <option value="{{ b.id }}">{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Servicio -->
      <div class="form-group">
        <label for="editService">Servicio:</label>
        <select id="editService" name="service_id" required>
          {% for s in services %}
            <option value="{{ s.id }}" data-precio="{{ s.precio }}">{{ s.name }}</option>
          {% endfor %}
        </select>

        <!-- üëá Campo para mostrar el precio del servicio -->
        <input
          type="text"
          id="editServicePrice"
          readonly
          style="background:#f9f9f9; border:1px solid #ddd; padding:5px; margin-top:5px; width:100%;"
        >
      </div>


      <!-- M√©todo de pago 1 -->
      <div class="form-group">
        <label for="editMethod1">M√©todo de Pago 1:</label>
        <select id="editMethod1" name="method1" required>
          {% for m in methods %}
            <option value="{{ m.id }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="editAmount1">Monto 1:</label>
        <input type="text" id="editAmount1" name="amount1" required>
      </div>

      <!-- M√©todo de pago 2 -->
      <div class="form-group">
        <label for="editMethod2">M√©todo de Pago 2 (opcional):</label>
        <select id="editMethod2" name="method2">
          <option value="">-- Ninguno --</option>
          {% for m in methods %}
            <option value="{{ m.id }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="editAmount2">Monto 2:</label>
        <input type="text" id="editAmount2" name="amount2">
      </div>

      <!-- Propina -->
      <div class="form-group">
        <label for="editTip">Propina:</label>
        <input type="text" id="editTip" name="tip" required>
      </div>

      <div class="form-group">
        <label for="editTotalPago">Total a Pagar:</label>
        <input type="text" name="editTotalPago" id="editTotalPago" placeholder="$" class="form-control" readonly>
      </div>
      
    </form>

    <!-- Bloque con padding alineado al resto del modal -->
    <div class="buttons-wrapper">
      <div class="modal-buttons">
        <!-- Bot√≥n Eliminar -->
        <form id="deletePaymentForm" method="POST" style="margin: 0; flex: 1;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button type="submit" class="delete-button" title="Eliminar pago">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </form>
    
        <!-- Bot√≥n Confirmar -->
        <button type="submit" form="editPaymentForm" class="edit-button" style="flex: 1;">
          <i class="fas fa-check"></i> Confirmar<br>cambios
        </button>
      </div>
    </div>
    

    <!-- 
      <div class="edit-buttons-container" style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
        <form id="deletePaymentForm" method="POST" style="margin: 0; flex-grow: 1;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button type="submit" class="delete-button" title="Eliminar pago">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </form>
        <button type="submit" form="editPaymentForm" class="edit-button" style="flex-grow: 1;">
          <i class="fas fa-check"></i> Confirmar cambios
        </button>
      </div>
    -->
      
  </div>
</div>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
<div id="confirmDeleteModal" class="modal-confirm">
  <div class="modal-confirm-content">
    <h3>¬øEliminar pago?</h3>
    <p>Esta acci√≥n no se puede deshacer.</p>
    <div class="modal-confirm-buttons">
      <button id="cancelDeleteBtn" class="btn btn-secondary">Cancelar</button>
      <button id="confirmDeleteBtn" class="btn btn-danger">Eliminar</button>
    </div>
  </div>
</div>


<div id="resultados-cierres">
  <!-- Aqu√≠ se renderizar√°n los resultados desde JavaScript -->
</div>

<script>
  document.getElementById('form-fechas').addEventListener('submit', async function (e) {
    e.preventDefault();

    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFinal = document.getElementById('fechaFinal').value;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const response = await fetch('/pagos_entre_fechas', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        start_date: fechaInicio,
        end_date: fechaFinal
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error("Error en respuesta:", response.status, errorText);
      return;
    }

    const data = await response.json();
    window.lastPagos = data.pagos;
    renderCierres(data);
  });

  function renderCierres(data) {
    const contenedor = document.getElementById('resultados-cierres');
    contenedor.innerHTML = ''; // Limpia resultados anteriores

    if (!data.pagos.length) {
      contenedor.innerHTML = '<p>No se encontraron pagos en el rango seleccionado.</p>';
      return;
    }

    // Renderiza el resumen de cierres (puedes mejorar el dise√±o)
    let html = `
      <h4><strong>Resumen de pagos: </strong></h4>

      <h6 class="titulo-con-linea"><strong> - Totales por m√©todo de pago:</strong></h6>
      <p class="metodos-pago">
        ${Object.entries(data.totales.metodos_pago).map(([m, v]) =>
          `<strong>${m}</strong>: $${parseInt(v).toLocaleString('es-AR')}`
        ).join(' | ')}
      </p>
      <div class="linea-inferior"></div>


      <h6 class="titulo-con-linea"><strong> - Totales por empleado:</strong></h6>
      <div class="empleado-scroll-wrap">
        <div class="empleados-grid">
          <div class="empleado-header">Empleado</div>
          <div class="empleado-header">Total</div>
          <div class="empleado-header">Cortes</div>
          <div class="empleado-header">Productos</div>
          <div class="empleado-header">Propinas</div>

          ${Object.entries(data.totales.empleados).map(([nombre, datos]) => {
            const totalConPropinas = parseFloat(datos.monto) + parseFloat(datos.propinas || 0);
            const montoCortes = parseFloat(datos.monto_cortes || 0);
            const montoProductos = parseFloat(datos.monto_productos || 0);
            const cortes = parseInt(datos.cortes || 0);
            const productos = parseInt(datos.productos || 0);
            const propinas = parseFloat(datos.propinas || 0);

            return `
              <div class="empleado-celda">${nombre}</div>
              <div class="empleado-celda">$${totalConPropinas.toLocaleString('es-AR')}</div>
              <div class="empleado-celda">$${montoCortes.toLocaleString('es-AR')} (${cortes})</div>
              <div class="empleado-celda">$${montoProductos.toLocaleString('es-AR')} (${productos})</div>
              <div class="empleado-celda">$${propinas.toLocaleString('es-AR')}</div>
            `;
          }).join('')}
        </div>
      </div>

      <div class="linea-inferior"></div>

      <p><strong>Total de cortes:</strong> ${Object.values(data.totales.empleados).reduce((acc, emp) => acc + (parseInt(emp.cortes) || 0), 0)}</p>
      <div class="linea-inferior"></div>

      <p><strong>Total de productos vendidos:</strong> ${Object.values(data.totales.empleados).reduce((acc, emp) => acc + (parseInt(emp.productos) || 0), 0)}</p>
      <div class="linea-inferior"></div>

      {% if role == "admin" %}
        <p><strong>Total propietario:</strong> $${parseInt(data.totales.propietario_total).toLocaleString('es-AR')}</p>
        <div class="linea-inferior"></div>

        <p><strong>Total general:</strong> $${parseInt(data.totales.monto_total).toLocaleString('es-AR')}</p>
        <div class="linea-inferior"></div>
      {% endif %}

    `;

    // Tabla de pagos
    html += `

      <h4><strong>Pagos entre Fechas: </strong></h4>
      <table class="table table-striped table-bordered text-center" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Empleado</th>
            <th>% Empleado</th>
            <th>Servicio</th>
            <th>Valor Servicio</th>
            <th>Producto</th>
            <th>Valor Producto</th>
            <th>Membresia</th>
            <th>Valor Membresia</th>
            <th>M. de Pago</th>
            <th>Monto</th>
            <th>Propina</th>
            <th>$ Empleado</th>
            <th>$ Propietario</th>
            <th>Editar</th>
          </tr>
        </thead>
        <tbody>
          ${data.pagos.map(p => `
            <tr>
              <td>${p.fecha}</td>
              <td>${p.empleado}</td>
              <td>
                ${Array.isArray(p.porcentaje_empleado)
                  ? p.porcentaje_empleado.map(pct => pct + '%').join(' - ')
                  : p.porcentaje_empleado + '%'}
              </td>
              <td>${p.servicio || '-'}</td>
              <td>${p.valor_servicio === 0 ? '-' : '$' + parseInt(p.valor_servicio).toLocaleString('es-AR')}</td>
              <td>${p.producto && p.producto.length ? p.producto.join(' - ') : '-'}</td>
              <td>
                ${p.montos_productos && p.montos_productos.length
                  ? p.montos_productos.map(m => '$' + parseInt(m).toLocaleString('es-AR')).join(' - ')
                  : '-'}
              </td>
              <td>
                ${
                  p.membresia
                    ? (
                        (parseFloat(p.amount1 || 0) === 0)
                          ? `Vale (${p.membresia})`
                          : p.membresia
                      )
                    : '-'
                }
              </td>
              <td>
                ${
                  p.membresia && parseFloat(p.monto || 0) === 0
                    ? '$0'
                    : (
                        p.valor_membresia === 0
                          ? '-'
                          : '$' + parseInt(p.valor_membresia).toLocaleString('es-AR')
                      )
                }
              </td>
              <td>
                ${
                  (p.membresia && parseFloat(p.amount1 || 0) === 0)
                    ? '-'
                    : (Array.isArray(p.metodo_pago) ? p.metodo_pago.join(' - ') : p.metodo_pago || '-')
                }
              </td>
              <td>${p.metodos_pago_str}</td>
              <td>$${parseInt(p.propina).toLocaleString('es-AR')}</td>
              <td>$${parseInt(p.pago_empleado).toLocaleString('es-AR')}</td>
              <td>
                ${
                  (p.membresia && parseFloat(p.amount1 || 0) === 0)
                    ? '$0'
                    : `$${parseInt(p.pago_propietario).toLocaleString('es-AR')}`
                }
              </td>
              <td>
                <button
                  type="button"
                  class="edit-icon ${p.tipo_pago === 'servicio' ? 'enabled' : 'disabled'}"
                  title="${p.tipo_pago === 'servicio' ? 'Editar pago' : 'Solo se pueden editar pagos de servicios'}"
                  ${p.tipo_pago === 'servicio'
                    ? `onclick="openEditModal(${p.id}, '${p.fecha}', '${p.empleado}', '${p.metodo_pago.join(' - ')}', ${p.monto || 0}, ${p.propina || 0})"`
                    : 'disabled'}
                >
                  <i class="fas fa-pen"></i>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    contenedor.innerHTML = html;
  }

  // Simular el env√≠o del formulario al cargar la p√°gina
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('form-fechas').dispatchEvent(new Event('submit'));
  });

  function openEditModal(id, fecha, empleado, metodo, monto, propina) {
    const modal = document.getElementById("editPaymentModal");
    const form = document.getElementById("editPaymentForm");

    // Buscar el pago en los datos renderizados (para obtener m√°s info)
    const pago = window.lastPagos.find(p => p.id === id);
    if (!pago) return;

    form.action = `/pagos/editar/${id}`;
    modal.style.display = "flex";
    modal.offsetHeight;
    modal.classList.add("active");

    // ‚úÖ Mostrar solo la fecha, pero luego se setea 23:59 al guardar
    if (pago.fecha_completa) {
      const fechaOriginal = new Date(pago.fecha_completa);
      const fechaLocal = fechaOriginal.toISOString().slice(0, 10); // solo yyyy-mm-dd
      document.getElementById("editDate").value = fechaLocal;
    } else {
      const hoy = new Date();
      const fechaLocal = hoy.toISOString().slice(0, 10);
      document.getElementById("editDate").value = fechaLocal;
    }

    // Empleado
    document.getElementById("editBarber").value = pago.empleado_id || "";

    // Servicio
    document.getElementById("editService").value = pago.service_id || "";

    // M√©todo 1 / Monto 1
    document.getElementById("editMethod1").value = pago.method1_id || "";
    document.getElementById("editAmount1").value = pago.amount1 || 0;
    document.getElementById("editAmount1").value = `$${(pago.amount1 || 0).toLocaleString("es-AR")}`;

    // M√©todo 2 / Monto 2
    document.getElementById("editMethod2").value = pago.method2_id || "";
    const monto2 = (pago.amount2 !== null && pago.amount2 !== undefined) ? pago.amount2 : 0;
    document.getElementById("editAmount2").value = `$${parseInt(monto2).toLocaleString("es-AR")}`;

    // Propina
    document.getElementById("editTip").value = `$${(pago.propina || 0).toLocaleString("es-AR")}`;

    document.getElementById("deletePaymentForm").action = `/payments/delete/${id}`;

    // --- Mostrar autom√°ticamente el precio del servicio seleccionado ---
    const serviceSelect = document.getElementById("editService");
    if (serviceSelect) {
      const selected = serviceSelect.options[serviceSelect.selectedIndex];
      const price = selected.getAttribute("data-precio");
      const priceInput = document.getElementById("editServicePrice");
      if (priceInput) {
        const numericPrice = parseFloat(price) || 0;
        priceInput.value = numericPrice ? `$${numericPrice.toLocaleString("es-AR")}` : "";
      }
    }

    updateEditTotalPago();
    
  }

  function closeEditModal() {
    const modal = document.getElementById("editPaymentModal");
    modal.classList.remove("active");
    setTimeout(() => {
      modal.style.display = "none";
    }, 300);
  }

  // Cerrar al click fuera
  window.onclick = function (event) {
    const modal = document.getElementById("editPaymentModal");
    if (event.target === modal) {
      closeEditModal();
    }
  };

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("editPaymentForm");
    const modal = document.getElementById("editPaymentModal");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      let valid = true;
      const errores = [];

      const method1 = document.getElementById("editMethod1").value;
      const method2 = document.getElementById("editMethod2").value;
      const amount1 = parseFloat(document.getElementById("editAmount1").value.replace(/\D/g, "") || "0");
      const amount2 = parseFloat(document.getElementById("editAmount2").value.replace(/\D/g, "") || "0");
      const tip = parseFloat(document.getElementById("editTip").value.replace(/\D/g, "") || "0");

      // --- Validar que si monto 2 es mayor a 0, se haya seleccionado un m√©todo de pago 2 distinto a "Ninguno" ---
      if (amount2 > 0 && (!method2 || method2 === "")) {
        errores.push("Si el monto 2 es mayor a 0, debe seleccionar un m√©todo de pago 2 distinto a 'Ninguno'.");
        valid = false;
      }

      // --- Validar duplicaci√≥n de m√©todos ---
      if (method1 && method2 && method1 === method2) {
        errores.push("No puede elegir el mismo m√©todo de pago dos veces.");
        valid = false;
      }

      // --- Validar montos ---
      if (amount1 < 0 || amount2 < 0 || tip < 0) {
        errores.push("Los montos y la propina no pueden ser negativos.");
        valid = false;
      }

      // --- Validar coherencia entre montos, propina y precio del servicio ---
      const serviceSelect = document.getElementById("editService");
      const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
      const precioServicio = parseFloat(selectedOption.getAttribute("data-precio") || "0");

      // Tomamos tambi√©n el total mostrado en el input "Total a Pagar"
      const totalMostrado = parseFloat(
        document.getElementById("editTotalPago").value.replace(/[^0-9,\.]/g, "").replace(/\./g, "").replace(",", ".")
      ) || 0;

      // Regla 1: monto2 == 0 ‚Üí monto1 + propina = totalMostrado
      // Regla 2: monto2 > 0  ‚Üí monto1 + monto2 = precioServicio + propina
      let diferencia = 0;
      if (amount2 === 0) {
        diferencia = Math.abs((amount1 + tip) - totalMostrado);
        if (diferencia > 0.01) {
          errores.push(`La suma de Monto 1 + Propina ($${(amount1 + tip).toLocaleString('es-AR')}) debe coincidir con el total a pagar ($${totalMostrado.toLocaleString('es-AR')}).`);
          valid = false;
        }
      } else {
        diferencia = Math.abs((amount1 + amount2) - (precioServicio + tip));
        if (diferencia > 0.01) {
          errores.push(`La suma de Monto 1 + Monto 2 ($${(amount1 + amount2).toLocaleString('es-AR')}) debe coincidir con el precio del servicio + propina ($${(precioServicio + tip).toLocaleString('es-AR')}).`);
          valid = false;
        }
      }


      // --- Mostrar errores si existen ---
      const container = document.getElementById("editFormErrorContainer");
      container.innerHTML = "";

      if (!valid) {
        const errorBox = document.createElement("div");
        errorBox.classList.add("error-message");
        errorBox.innerHTML = `
          <strong>Se encontraron los siguientes errores:</strong>
          <ul>${errores.map(e => `<li>${e}</li>`).join("")}</ul>
        `;
        container.appendChild(errorBox);
        errorBox.classList.add("shake");
        setTimeout(() => errorBox.classList.remove("shake"), 400);

        const modalContent = document.getElementById("editPaymentModalContent");
        if (modalContent) modalContent.scrollTo({ top: 0, behavior: "smooth" });
        return; // Detener el env√≠o
      }

      // --- Si todo est√° bien, completar fecha y enviar ---
      const inputFecha = document.getElementById("editDate");
      const inputHidden = document.getElementById("editDateHidden");
      if (inputFecha && inputFecha.value) {
        const fechaEditada = new Date(inputFecha.value);
        fechaEditada.setHours(23, 59, 0, 0);
        inputHidden.value = fechaEditada.toISOString().slice(0, 16);
      }

      // üëá Forzar env√≠o manual s√≥lo si pas√≥ todas las validaciones
      form.submit();
    });
  });

  document.getElementById("editService").addEventListener("change", function() {
    const selected = this.options[this.selectedIndex];
    const price = selected.getAttribute("data-precio");
    document.getElementById("editServicePrice").value = price ? `$${price}` : "";
  });

  // Abrir modal de confirmaci√≥n
  document.getElementById("deletePaymentForm").addEventListener("submit", function(e) {
    e.preventDefault(); // prevenir env√≠o inmediato
    document.getElementById("confirmDeleteModal").classList.add("active");
  });

  // Bot√≥n cancelar
  document.getElementById("cancelDeleteBtn").addEventListener("click", function() {
    document.getElementById("confirmDeleteModal").classList.remove("active");
  });

  // Bot√≥n confirmar
  document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
    document.getElementById("confirmDeleteModal").classList.remove("active");
    document.getElementById("deletePaymentForm").submit(); // env√≠a el formulario real
  });

  function formatCurrencyInput(input) {
    const value = parseFloat(input.value.replace(/\D/g, "")) || 0;
    input.value = value ? `$${value.toLocaleString("es-AR")}` : "$0";
  }

  function attachCurrencyFormatting(id) {
    const input = document.getElementById(id);
    if (!input) return;

    // Mostrar formato correcto al ingresar al modal
    input.addEventListener("focus", () => {
      const numericValue = input.value.replace(/\D/g, "");
      input.value = numericValue ? numericValue : "";
    });

    // Mostrar formato $X.XXX al salir del input
    input.addEventListener("blur", () => formatCurrencyInput(input));
  }


  function updateEditTotalPago() {
    // Limpia todo lo que no sea d√≠gito o coma/punto decimal
    const cleanValue = (value) => {
      if (!value) return 0;
      // Eliminar s√≠mbolo $, puntos de miles y espacios
      const numeric = value.replace(/[^0-9,.-]/g, "").replace(/\./g, "").replace(",", ".");
      return parseFloat(numeric) || 0;
    };

    const amount1 = cleanValue(document.getElementById("editAmount1").value);
    const amount2 = cleanValue(document.getElementById("editAmount2").value);
    const tip = cleanValue(document.getElementById("editTip").value);

    const total = amount1 + amount2 /* + tip */;
    document.getElementById("editTotalPago").value = `$${total.toLocaleString("es-AR")}`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const amount1Input = document.getElementById("editAmount1");
    const amount2Input = document.getElementById("editAmount2");
    const tipInput = document.getElementById("editTip");

    if (amount1Input) {
      attachCurrencyFormatting("editAmount1");
      amount1Input.addEventListener("input", updateEditTotalPago);
    }
    if (amount2Input) {
      attachCurrencyFormatting("editAmount2");
      amount2Input.addEventListener("input", updateEditTotalPago);
    }
    if (tipInput) {
      attachCurrencyFormatting("editTip");
      tipInput.addEventListener("input", updateEditTotalPago);
    }

    updateEditTotalPago();
  });

</script>

{% endblock %}
