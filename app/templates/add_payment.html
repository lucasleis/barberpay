{% extends "layout.html" %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-messages" class="w-100 position-fixed top-0 start-0" style="z-index: 1050;">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show text-center m-0 rounded-0" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<h2>Registrar un nuevo pago</h2>

<form method="POST" id="paymentForm" action="{{ url_for('add_payment') }}">
  <input type="hidden" name="salon_id" value="{{ salon_id }}">

  <!-- Selector de Barbero -->
  <label for="barber_id">Barbero:</label>
  <select name="barber_id" required>
    {% for b in barbers %}
      <option value="{{ b.id }}">{{ b.name }}</option>
    {% endfor %}
  </select>


  <!-- Toggle Servicio, Producto o Membresia-->
  <div id="toggleContainer" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
    <div style="flex: 1;">
      <input type="checkbox" class="btn-check" id="toggleServicio" name="toggle_servicio" autocomplete="off" checked>
      <label class="btn full-width" for="toggleServicio">Servicio</label>
    </div>
    <div style="flex: 1;">
      <input type="checkbox" class="btn-check" id="toggleProducto" name="toggle_producto" autocomplete="off">
      <label class="btn full-width" for="toggleProducto">Producto</label>
    </div>
    <div style="flex: 1;">
      <input type="checkbox" class="btn-check" id="toggleMembresia" name="toggle_membresia" autocomplete="off">
      <label class="btn full-width" for="toggleMembresia">Membres√≠a</label>
    </div>
  </div>
  <p id="toggleError" class="text-danger mt-1" style="display: none;"> 
    Debe seleccionar "Servicio", "Producto" o "Membresia".
  </p>                                                    


  <!-- Selector de servicio -->
  <div id="servicioSection">
    <label for="service_id">Servicio y precio:</label>
    <div style="display: flex; gap: 1rem;">
      <select name="service_id" id="serviceSelect" required>
        {% for s in services %}
          <option value="{{ s.id }}" data-precio="{{ s.precio }}">
            {{ s.name }}
          </option>
        {% endfor %}
      </select>
      <input type="text" id="servicePrice" disabled placeholder="$" style="width: 100px;">
    </div>
  </div>


  <!-- Selector de productos -->
  <div id="productSection">
    <div class="productRow" data-index="0">
      <label>Producto:</label>
      <div style="display: flex; gap: 1rem;">
        <select name="product_id" class="productSelect" onchange="updateCantidadOptions(this)">
          {% for product in products %}
            {% if product.cantidad > 0 %}
              <option value="{{ product.id }}" data-precio="{{ product.precio }}" data-cantidad="{{ product.cantidad }}">
                {{ product.name }}
              </option>
            {% endif %}
          {% endfor %}
        </select>

        <select class="productCant" name="product_quantity" style="width: 100px;">
          <!-- Se llena din√°micamente con JS -->
        </select>

        <input type="text" class="productPrice" disabled placeholder="$" style="width: 100px;">
        <button type="button" class="addProductBtn">+</button>
        <button type="button" class="removeProductBtn">‚àí</button>
      </div>
    </div>
  </div>
  <p id="messageContainer" class="error-msg" style="display: none; color: red; font-size: 0.9rem;"></p>


  <!-- Selector de membres√≠a -->
  <div id="membresiaSection" style="display: none;">
    <label for="membresia_id">Membres√≠a:</label>
    <div style="display: flex; gap: 1rem;">
      <select name="membresia_id" id="membresiaSelect">
        {% for membresia in membresias %}
          <option 
            value="{{ membresia.id }}" 
            data-usos="{{ membresia.usos_disponibles }}"
            data-precio="{{ membresia.precio }}">
            {{ membresia.nombre }}
          </option>
        {% endfor %}
      </select>
      <input type="text" id="membreciaPrice" disabled placeholder="$" style="width: 100px;">
    </div>
  </div>
  <p id="messageContainer" class="error-msg" style="display: none; color: red; font-size: 0.9rem;"></p>


  <!-- Metodo de Pago -->
  <div style="display: flex; align-items: center; justify-content: space-between;">
    <label for="method">M√©todo de pago:</label>
    <label class="checkbox-label">
      <input type="checkbox" id="multiPaymentToggle" name="togglemultiPayment"> ¬øUsa m√∫ltiples m√©todos?
    </label>
    <label class="checkbox-label">
      <input type="checkbox" id="membresiaCheckbox" name="membresiaCheckbox"> ¬øUsa Membres√≠a?
    </label>
  </div>

  <!-- Modo simple -->
  <div id="singleMethodGroup" class="payment-method-group">
    <select id="methodSimple" name="methodSimple">
      {% for method in methods %}
        <option value="{{ method.id }}">{{ method.nombre }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="amount_simple" id="amountSimple">
  </div>

  <!-- Modo m√∫ltiple -->
  <div id="multiMethodGroup" style="display: none;">
    <div class="payment-method-group">
      <select name="method_multiple_1" id="method_multiple_1">
        {% for method in methods %}
          <option value="{{ method.id }}">{{ method.nombre }}</option>
        {% endfor %}
      </select>
      <input type="number" name="amount_method_multi_1" id="amount_method_multi-1" step="1" placeholder="Monto $">
    </div>

    <div class="payment-method-group">
      <select name="method_multiple_2" id="method_multiple_2">
        {% for method in methods %}
          <option value="{{ method.id }}">{{ method.nombre }}</option>
        {% endfor %}
      </select>
      <input type="number" name="amount_method_multi_2" id="amount_method_multi_2" step="1" placeholder="Monto $">
    </div>

    <!-- Mensajes de error -->
    <p id="multiPaymentError" class="error-msg" style="display: none; color: red; font-size: 0.9rem;">
      La suma de los montos debe ser igual al precio del servicio.
    </p>
    <p id="methodRepeatError" class="error-msg" style="display: none; color: red; font-size: 0.9rem;">
      Los m√©todos de pago deben ser diferentes.
    </p>
    <p id="montoError" class="error-msg" style="display: none; color: red; font-size: 0.9rem;">
      El total pagado no coincide con el total esperado.
    </p>
  </div>

  <!-- Membresia -->
  <div id="membresiaMethodGroup" style="display: none;">
    <div class="membresia-method-group">
      <input type="number" name="check_membresia" id="check_membresia" step="1" placeholder="N√∫mero de Membres√≠a">
    </div>

    <!-- Mensajes de error -->
    <p id="methodRepeatError2" class="error-msg" style="display: none; color: red; font-size: 0.9rem;">
      Debe ingresar un n√∫mero de membres√≠a v√°lido.
    </p>
  </div>

  <!-- Propina y bot√≥n -->
  <div class="mb-3">
    <label for="tip" class="form-label">Propina:</label>
    <div class="propina-row">
      <input type="number" name="tip" id="tip" step="100" placeholder="$">
      <button type="submit">Guardar pago</button>
    </div>
  </div>
</form>

<h3>Pagos Hoy</h3>

<table class="table table-striped table-bordered text-center" style="margin-top: 1rem;">
  <thead>
    <tr>
      <th>Hora</th>
      <th>Barbero</th>
      <th>Servicio</th>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Membresia</th>
      <th>M. Pago </th>
      <th>Monto</th>
      <th>M. Pago</th>
      <th>Monto</th>
      <th>Propina</th>
      <th>Monto Total</th>
      <th>Borrar Pago</th>
    </tr>
  </thead>
  {% for pago in pagos %}
    <tr>
      <td>{{ pago.date.strftime('%H:%M') }}</td>
      <td>{{ pago.appointment.barber.name }}</td>
      <td>{{ pago.appointment.service.name if pago.appointment.service else '-' }}</td>
      <td>{{ pago.appointment.producto.name if pago.appointment.producto else '-' }}</td>
      <td>{{ pago.appointment.cantidad if pago.appointment.producto else '-' }}</td>
      <td>{{ pago.appointment.membresia.id if pago.appointment.membresia else '-' }}</td>
      <td>{{ pago.method1.nombre }}</td>
      <td>${{ pago.amount_method1|int }}</td>
      <td>{{ pago.method2.nombre if pago.method2 else '-' }}</td>
      <td>{{ '-' if pago.amount_method2|int == 0 else '$' ~ (pago.amount_method2|int) }}</td>
      <td>${{ pago.amount_tip|int }}</td>
      <!-- <td>${{ pago.amount_method1|int + pago.amount_method2|int + pago.amount_tip|int }}</td> -->
      <td>${{ pago.amount_method1|int + pago.amount_method2|int }}</td>
      <td class="borrar-pago">
        <form method="POST" action="{{ url_for('delete_payment', pago_id=pago.id) }}">
          <button type="submit" class="btn btn-danger" title="Eliminar">üóëÔ∏è</button>
        </form>
      </td>
    </tr>
  {% endfor %}
</table>


<script>
  const serviceSelect = document.getElementById('serviceSelect');
  const servicePrice = document.getElementById('servicePrice');
  const togglemultiPayment = document.getElementById('multiPaymentToggle');
  const productToggle = document.getElementById('productToggle');
  const singleGroup = document.getElementById('singleMethodGroup');
  const multiGroup = document.getElementById('multiMethodGroup');
  const form = document.getElementById('paymentForm');
  const errorMsg = document.getElementById('multiPaymentError');
  const repeatError = document.getElementById('methodRepeatError');
  
  // const amount1 = document.getElementById('amount1');
  // const amount2 = document.getElementById('amount2');
  const amountSimple = document.getElementById('amountSimple');
  const method1Select = document.getElementById('method1');
  const method2Select = document.getElementById('method2');


  const servicioToggle = document.getElementById('toggleServicio');
  const productoToggle = document.getElementById('toggleProducto');
  const membresiaToggle = document.getElementById('toggleMembresia');

  const servicioSection = document.getElementById('servicioSection');
  const productSection = document.getElementById('productSection');
  const membresiaSelect = document.getElementById('membresiaSelect');
  const priceInput = document.getElementById('membreciaPrice');


  // console.log("productPrice: "+ productPrice.value)
  // console.log("productCant: "+ productCant.value)

  // Funci√≥n para mostrar/ocultar secciones seg√∫n el toggle (servicio/producto)
  function updateToggleSections() {
    servicioSection.style.display = servicioToggle.checked ? 'block' : 'none';
    productSection.style.display = productoToggle.checked ? 'block' : 'none';
    membresiaSection.style.display = membresiaToggle.checked ? 'block' : 'none';
  }

  // Actualiza din√°micamente las opciones de cantidad seg√∫n el producto seleccionado
  function updateCantidadOptions(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const cantidadDisponible = parseInt(selectedOption.dataset.cantidad || 0);

    const cantidadSelect = document.querySelector('.productCant');
    cantidadSelect.innerHTML = ''; // Limpiar opciones previas

    for (let i = 1; i <= cantidadDisponible; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      cantidadSelect.appendChild(option);
    }
  }

  // Funci√≥n que actualiza el precio del servicio seleccionado y lo asigna al input de solo lectura
  function updatePrice() {
    const selected = serviceSelect.options[serviceSelect.selectedIndex];
    const precio = selected.getAttribute('data-precio');
    const precioFloat = Math.round(parseFloat(precio).toFixed(2));
    servicePrice.value = `$${precioFloat}`;
    amountSimple.value = precioFloat;

    // console.log("servicePrice.value: "+servicePrice.value);
  }

  updatePrice();      // Se llama una vez al cargar la p√°gina para mostrar el precio inicial
  serviceSelect.addEventListener('change', updatePrice);    // Actualiza el precio cada vez que se cambia el servicio seleccionado

  // Oculta alertas autom√°ticamente despu√©s de 15 segundos
  setTimeout(() => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      alert.classList.remove('show');
      alert.classList.add('fade');
      setTimeout(() => alert.remove(), 1000); 
    });
  }, 15000);

  // Evento para alternar entre modo de pago simple y m√∫ltiple
  togglemultiPayment.addEventListener('change', function () {
    if (this.checked) {
      // Si se activa el pago m√∫ltiple, ocultar el modo simple y mostrar campos adicionales
      singleGroup.style.display = 'none';
      multiGroup.style.display = 'block';
      multiGroup.querySelectorAll('input').forEach(el => el.required = true);
    } else {
      // Si se desactiva, volver al modo simple
      singleGroup.style.display = 'flex';
      multiGroup.style.display = 'none';
      multiGroup.querySelectorAll('input').forEach(el => {
        el.required = false;
        el.classList.remove('input-error');
      });
      multiGroup.querySelectorAll('select').forEach(el => el.classList.remove('input-error'));
      errorMsg.style.display = 'none';
      repeatError.style.display = 'none';
    }
  });


  function mostrarErrorToggle(mostrar) {
    toggleError.style.display = mostrar ? 'block' : 'none';
    toggleContainer.classList.toggle('border', mostrar);
    toggleContainer.classList.toggle('border-danger', mostrar);
    toggleContainer.classList.toggle('rounded', mostrar);
    toggleContainer.classList.toggle('p-2', mostrar);
  }

  function obtenerPrecioServicio() {
    const select = document.getElementById('serviceSelect');
    const selected = select.options[select.selectedIndex];
    return parseFloat(selected.getAttribute('data-precio')) || 0;
  }

  function obtenerProductosSeleccionados() {
    const rows = document.querySelectorAll('#productSection .productRow');
    const items = [];
    let total = 0;

    rows.forEach((row) => {
      const productSelect = row.querySelector('.productSelect');
      const cantidadSelect = row.querySelector('.productCant');

      if (!productSelect || !cantidadSelect) return;

      const selected = productSelect.options[productSelect.selectedIndex];
      const id = selected.value;
      const precio = parseFloat(selected.getAttribute('data-precio')) || 0;
      const cantidad = parseInt(cantidadSelect.value) || 0;

      if (cantidad > 0) {
        items.push({ id, precio, cantidad });
        total += precio * cantidad;
      }
    });

    return { total, items };
  }

  function agregarInputsOcultos(productos) {
    productos.forEach((producto, index) => {
      const inputId = crearInputOculto(`product_id_${index}`, producto.id);
      const inputCant = crearInputOculto(`cantidad_${index}`, producto.cantidad);
      form.appendChild(inputId);
      form.appendChild(inputCant);
    });
  }

  function crearInputOculto(nombre, valor) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = nombre;
    input.value = valor;
    return input;
  }

function validarMultiplesMetodos(totalEsperado) {
  const form = document.querySelector('form');
  const repeatError = document.getElementById('methodRepeatError');

  const amount1 = parseFloat(form.querySelector('input[name="amount_method_multi_1"]').value) || 0;
  const amount2 = parseFloat(form.querySelector('input[name="amount_method_multi_2"]').value) || 0;
  const totalPagado = amount1 + amount2;

  const method1 = form.querySelector('select[name="method_multiple_1"]').value;
  const method2 = form.querySelector('select[name="method_multiple_2"]').value;

  const metodoInputs = [
    form.querySelector('select[name="method_multiple_1"]'),
    form.querySelector('select[name="method_multiple_2"]')
  ];

  console.log("llega validar metodos")

  // Validar m√©todos repetidos
  if (method1 === method2) {
    console.log("entra if method")
    metodoInputs.forEach(select => select.classList.add('input-error'));
    repeatError.style.display = 'block';
    return false;
  } else {
    console.log("entra else method")
    metodoInputs.forEach(select => select.classList.remove('input-error'));
    repeatError.style.display = 'none';
  }

  console.log("llega validar total")

  // Validar que el total pagado sea correcto
  const montoError = document.getElementById('montoError');

  if (totalPagado !== totalEsperado) {
    montoError.style.display = 'block';
    return false;
  } else {
    montoError.style.display = 'none';
  }

  return true;
}


  // Validaciones al enviar el formulario
  // Validar que haga las mismas validaciones que func python
  /*
    form.addEventListener('submit', function (e) {
      let valid = true;
      const toggleError = document.getElementById('toggleError');
      const toggleContainer = document.getElementById('toggleContainer');
      console.log("servicioToggle.checked", servicioToggle.checked)
      console.log("productoToggle.checked", productoToggle.checked)

      // Validaci√≥n: al menos uno de los toggles debe estar activo
      if (!servicioToggle.checked && !productoToggle.checked) {
        toggleError.style.display = 'block';
        toggleContainer.classList.add('border', 'border-danger', 'rounded', 'p-2');
        e.preventDefault();
        return;
      } else {
        toggleError.style.display = 'none';
        toggleContainer.classList.remove('border', 'border-danger', 'rounded', 'p-2');
      }


      // Obtener servicio
      let servicePrecio = 0;
      let serviceId = null;
      if (servicioToggle.checked) {
        console.log("ENTRA TOGGLE SERVICIO");
        const serviceSelect = document.getElementById('serviceSelect');
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        serviceId = selectedOption.value;
        servicePrecio = parseFloat(selectedOption.getAttribute('data-precio'));
      }

      // Obtener productos
      let productosSeleccionados = [];
      let productosPrecioTotal = 0;
      if (productoToggle.checked) {
        console.log("ENTRA TOGGLE PRODUCTO");
        const productRows = document.querySelectorAll('#productSection .productRow');

        productRows.forEach((row) => {
          const productSelect = row.querySelector('.productSelect');
          const cantidadSelect = row.querySelector('.productCant');

          if (!productSelect || !cantidadSelect) return;

          const selectedOption = productSelect.options[productSelect.selectedIndex];
          const productId = selectedOption.value;
          const productPrecio = parseFloat(selectedOption.getAttribute('data-precio'));
          const cantidad = parseInt(cantidadSelect.value);

          if (cantidad > 0) {
            productosSeleccionados.push({
              id: productId,
              precio: productPrecio,
              cantidad: cantidad
            });

            productosPrecioTotal += productPrecio * cantidad;
          }
        });

        if (productosSeleccionados.length === 0) {
          alert('Debe seleccionar al menos un producto con cantidad v√°lida');
          e.preventDefault();
          return;
        }

        productosSeleccionados.forEach((producto, index) => {
          console.log(`Producto ${index + 1}: ID: ${producto.id}, Precio: ${producto.precio}, Cantidad: ${producto.cantidad}`);

          const inputId = document.createElement('input');
          inputId.type = 'hidden';
          inputId.name = `product_id_${index}`;
          inputId.value = producto.id;
          form.appendChild(inputId);

          const inputCant = document.createElement('input');
          inputCant.type = 'hidden';
          inputCant.name = `cantidad_${index}`;
          inputCant.value = producto.cantidad;
          form.appendChild(inputCant);
        });
      }

      // Calcular total esperado
      const totalEsperado = servicePrecio + productosPrecioTotal;
      // console.log('Total esperado:', totalEsperado);

      // console.log('togglemultiPayment:', togglemultiPayment.checked);
      if (togglemultiPayment.checked) {
        const amount1 = parseFloat(form.querySelector('input[name="amount_method_multi_1"]').value) || 0;
        const amount2 = parseFloat(form.querySelector('input[name="amount_method_multi_2"]').value) || 0;
        const total_multi_methods = amount1 + amount2;

        // console.log('amount1:', amount1, ' amount2:', amount2);
        console.log('amount1 + amount2:', total_multi_methods);

        if (total_multi_methods === totalEsperado) {
          console.log("SUMA CORRECTA");
        }

        // Validar que no se repita el m√©todo de pago
        const method1 = form.querySelector('select[name="method_multiple_1"]').value;
        const method2 = form.querySelector('select[name="method_multiple_2"]').value;

        if (method1 === method2) {
          [form.querySelector('select[name="method_multiple_1"]'), form.querySelector('select[name="method_multiple_2"]')]
            .forEach(select => select.classList.add('input-error'));
          repeatError.style.display = 'block';
          valid = false;
        } else {
          [form.querySelector('select[name="method_multiple_1"]'), form.querySelector('select[name="method_multiple_2"]')]
            .forEach(select => select.classList.remove('input-error'));
          repeatError.style.display = 'none';
        }
      }

      if (!valid) {
        e.preventDefault();
      }
    });
  */
  form.addEventListener('submit', function (e) {
    let valid = true;

    const toggleError = document.getElementById('toggleError');
    const toggleContainer = document.getElementById('toggleContainer');

    const servicioActivo = servicioToggle.checked;
    const productoActivo = productoToggle.checked;
    const membresiaActivo = membresiaToggle.checked;

    // Validar toggles
    if (!servicioActivo && !productoActivo && !membresiaActivo) {
      mostrarErrorToggle(true);
      e.preventDefault();
      return;
    } else {
      mostrarErrorToggle(false);
    }

    if (servicioActivo || productoActivo){
      const servicePrecio = servicioActivo ? obtenerPrecioServicio() : 0;
      const productosData = productoActivo ? obtenerProductosSeleccionados() : { total: 0, items: [] };

      if (productoActivo && productosData.items.length === 0) {
        alert('Debe seleccionar al menos un producto con cantidad v√°lida');
        e.preventDefault();
        return;
      }

      agregarInputsOcultos(productosData.items);

      const totalEsperado = servicePrecio + productosData.total;
      console.log("totalEsperado: ",totalEsperado)

      if (togglemultiPayment.checked) {
        const validMultiPago = validarMultiplesMetodos(totalEsperado);
        if (!validMultiPago) valid = false;
      }
      console.log("pasa if")

    }

    if (membresiaActivo){

      const usa_membresia = document.getElementById('membresiaCheckbox');
      
      if (usa_membresia.checked) {

        const num_membresia = document.getElementById('check_membresia');
        console.log("num_membresia: ", num_membresia)

      } else {
        console.log("paga membresia")
        const precioActual = obtenerPrecioMembresiaSeleccionada();
        console.log('Precio de la membres√≠a seleccionada:', precioActual);

        const totalEsperado = precioActual;

        if (togglemultiPayment.checked) {
          const validMultiPago = validarMultiplesMetodos(totalEsperado);
          if (!validMultiPago) valid = false;
          
          if (validMultiPago){
            console.log('Precio valido');
          } else {
            console.log('Error en cuentas');
          } 
        }
      }
    }

    if (!valid) {
      e.preventDefault();
    }
  });


  // Limpia el error de validaci√≥n en los inputs de monto al modificarlos
  document.querySelectorAll('input[name="amount1"], input[name="amount2"]').forEach(input => {
    input.addEventListener('input', () => {
      input.classList.remove('input-error');
      errorMsg.style.display = 'none';
    });
  });

  // Limpia el error si se corrige la selecci√≥n de m√©todos de pago
  document.querySelectorAll('select[name="method1"], select[name="method2"]').forEach(select => {
    select.addEventListener('change', () => {
      select.classList.remove('input-error');
      repeatError.style.display = 'none';
    });
  });

  // Inicial
  updateToggleSections();   // Inicializa visibilidad de secciones al cargar el script

  // Listeners que actualizan la visibilidad si el usuario cambia de opci√≥n
  servicioToggle.addEventListener('change', updateToggleSections);
  productoToggle.addEventListener('change', updateToggleSections);
  membresiaToggle.addEventListener('change', updateToggleSections);

  // Espera que el DOM est√© listo para manipular elementos del producto
  document.addEventListener('DOMContentLoaded', function () {
    const productSection = document.getElementById('productSection');

    function updatePrice(row) {
      const precio = parseFloat(row.querySelector('.productSelect').selectedOptions[0].dataset.precio || 0);
      const cantidad = parseInt(row.querySelector('.productCant').value || 1);
      const total = precio * cantidad;
      row.querySelector('.productPrice').value = `$${Math.round(total)}`;
    }

    // Evento para agregar productos
    productSection.addEventListener('click', function (e) {
      if (e.target.classList.contains('addProductBtn')) {
        const currentRow = e.target.closest('.productRow');
        const newRow = currentRow.cloneNode(true);

        newRow.querySelector('.productSelect').selectedIndex = 0;
        newRow.querySelector('.productCant').selectedIndex = 0;
        newRow.querySelector('.productPrice').value = '';
        productSection.appendChild(newRow);

        // Calcular precio para la nueva fila
        updatePrice(newRow);

        const messageContainer = document.getElementById('messageContainer');
        messageContainer.style.display = 'none';
        messageContainer.textContent = '';
      }
    });

    // Evento para recalcular precios cuando se cambia un valor
    productSection.addEventListener('change', function (e) {
      if (e.target.classList.contains('productSelect') || e.target.classList.contains('productCant')) {
        const row = e.target.closest('.productRow');
        updatePrice(row);
      }
    });

    // Calcular precio inicial para cada fila ya presente (por ejemplo, la primera)
    document.querySelectorAll('.productRow').forEach(row => {
      updatePrice(row);
    });
  });

  // Permite eliminar una fila de producto, dejando al menos una
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('removeProductBtn')) {
      const row = e.target.closest('.productRow');
      const rows = document.querySelectorAll('.productRow');

      const messageContainer = document.getElementById('messageContainer');

      if (rows.length > 1) {
        row.remove();
        messageContainer.style.display = 'none';
        messageContainer.textContent = '';
      } else {
        messageContainer.style.display = 'block';
        messageContainer.textContent = 'Debe haber al menos un producto.';
      }
    }
  });

  // Carga las opciones de cantidad iniciales al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function () {
    const productSelect = document.querySelector('.productSelect');
    if (productSelect) {
      updateCantidadOptions(productSelect);
    }
  });

  // Muestra/oculta los m√©todos de pago seg√∫n si est√° marcada la membres√≠a
  document.addEventListener('DOMContentLoaded', function () {
    const checkbox = document.getElementById('membresiaCheckbox');
    const membershipDiv = document.getElementById('membresiaMethodGroup');
    const multiPaymentToggle = document.getElementById('multiPaymentToggle');
    const singleMethodGroup = document.getElementById('singleMethodGroup');

    checkbox.addEventListener('change', function () {
      if (checkbox.checked) {
        membershipDiv.style.display = 'block';
        multiPaymentToggle.closest('label').style.display = 'none'; // Oculta el label completo
        singleMethodGroup.style.display = 'none';
      } else {
        membershipDiv.style.display = 'none';
        multiPaymentToggle.closest('label').style.display = 'inline-block'; // Muestra el label
        singleMethodGroup.style.display = 'block';
      }
    });
  }); 

  function mostrarError(campo, mensaje) {
    campo.classList.add('input-error');
    mensaje.style.display = 'block';
  }

  function ocultarError(campo, mensaje) {
    campo.classList.remove('input-error');
    mensaje.style.display = 'none';
  }


  // funciones para membresia

  function obtenerPrecioMembresiaSeleccionada() {
    const selectedOption = membresiaSelect.options[membresiaSelect.selectedIndex];
    const precio = selectedOption.getAttribute('data-precio');
    return precio ? parseFloat(precio) : 0;
  }

  membresiaSelect.addEventListener('change', function () {
    const selectedOption = membresiaSelect.options[membresiaSelect.selectedIndex];
    const precio = selectedOption.getAttribute('data-precio');

    priceInput.value = precio ? `$${parseFloat(precio).toFixed(0)}` : '';
  });

  // Trigger al cargar la p√°gina para preseleccionados
  document.addEventListener('DOMContentLoaded', () => {
    membresiaSelect.dispatchEvent(new Event('change'));
  });

</script>

{% endblock %}
