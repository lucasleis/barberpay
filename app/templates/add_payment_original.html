{% extends "layout.html" %}

{% block content %}

<h2>Registrar un nuevo pago</h2>

<form method="POST" id="paymentForm" action="{{ url_for('add_payment') }}">
  <input type="hidden" name="salon_id" value="{{ salon_id }}">

  <!-- Selector de Barbero -->
  <div class="form-group">
    <label for="barber_id">Barbero:</label>
    <select name="barber_id" required>
      {% for b in barbers %}
        <option value="{{ b.id }}">{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Toggle Servicio, Producto o Membresia-->
  <div class="form-group">
    <div id="toggleContainer">
      <div>
        <input type="checkbox" class="btn-check" id="toggleServicio" name="toggle_servicio" autocomplete="off" checked>
        <label class="btn full-width" for="toggleServicio">Servicio</label>
      </div>
      <div>
        <input type="checkbox" class="btn-check" id="toggleProducto" name="toggle_producto" autocomplete="off">
        <label class="btn full-width" for="toggleProducto">Producto</label>
      </div>
      <div>
        <input type="checkbox" class="btn-check" id="toggleMembresia" name="toggle_membresia" autocomplete="off">
        <label class="btn full-width" for="toggleMembresia">Membresía</label>
      </div>
    </div>
    <p id="toggleError" class="text-danger mt-1" style="display: none;"> 
      Debe seleccionar "Servicio", "Producto" o "Membresia".
    </p>
  </div>

  <!-- Selector de servicio -->
  <div id="servicioSection" class="form-group">
    <div class="form-row-flex">
      <label for="service_id">Servicio y precio:</label>
      <div class="checkbox-group servicio-precio">
        <div class="checkbox-left">
          <label class="checkbox-label">
            <input type="checkbox" id="precioDescuentoCheckbox" name="precioDescuentoCheckbox">
            <span class="checkbox-text">¿Precio Descuento?</span>
          </label>
        </div>
        <div class="checkbox-right">
          <label class="checkbox-label">
            <input type="checkbox" id="precioAmigoCheckbox" name="precioAmigoCheckbox">
            <span class="checkbox-text">¿Vale por Corte?</span>
          </label>
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 1rem;">
      <select name="service_id" id="serviceSelect" required>
        {% for s in services %}
          <option value="{{ s.id }}"
              data-precio="{{ s.precio }}"
              data-precio-amigo="{{ s.precio_amigo or 0 }}"
              data-precio-descuento="{{ s.precio_descuento or 0 }}">
            {{ s.name }}
          </option>
        {% endfor %}
      </select>
      <input type="text" id="servicePrice" name="servicePrice" readonly placeholder="$" value="${{ '{:,.0f}'.format(precio|default(0)).replace(',', '.') }}" style="width: 100px;">
    </div>
  </div>

  <!-- Selector de productos -->
  <div id="productSection" class="form-group" style="display: none;">
    <div class="productRow" data-index="0">
      <label>Producto:</label>
      <div>
        <select name="product_id[]" class="productSelect" onchange="updateCantidadOptions(this)">
          {% for product in products %}
            {% if product.cantidad > 0 %}
              <option value="{{ product.id }}" data-precio="{{ product.precio }}" data-cantidad="{{ product.cantidad }}">
                {{ product.name }}
              </option>
            {% endif %}
          {% endfor %}
        </select>

        <div class="productCant-container">
          <select class="productCant" name="product_quantity[]"></select> 
          <button type="button" class="addProductBtn btn-primary">+</button>
          <button type="button" class="removeProductBtn btn-primary">−</button>

          <input type="text" class="productPrice" disabled placeholder="$">
        </div>
      </div>
    </div>
  </div>
  <p id="messageContainer" class="error-msg" style="display: none; color: red; font-size: 0.9rem;"></p>

  <!-- Selector de membresía -->
  <div id="membresiaSection" class="form-group" style="display: none;">
    <label for="membresia_id">Membresía y precio:</label>
    <div style="display: flex; gap: 1rem;">
      <select name="membresia_id" id="membresiaSelect">
        {% for membresia in membresias %}
          <option value="{{ membresia.id }}" data-usos="{{ membresia.usos_disponibles }}" data-precio="{{ membresia.precio }}">
            {{ membresia.nombre }}
          </option>
        {% endfor %}
      </select>
      <input type="text" id="membreciaPrice" disabled placeholder="$" style="width: 100px;">
    </div>
  </div>

  <!-- Metodo de Pago -->
  <div class="form-group payment-methods">
    <div class="form-row-flex">
      <label for="method">Método de pago:</label>
      <div class="checkbox-group metodo-pago">
        <div class="checkbox-left">
          <label id="membresiaLabel" name="membresiaLabel" class="checkbox-label" style="display: flex;">
            <input type="checkbox" id="membresiaCheckbox" name="membresiaCheckbox">
            <span class="checkbox-text">¿Usa Membresía?</span>
          </label>
        </div>
        <div class="checkbox-right">
          <label class="checkbox-label">
            <input type="checkbox" id="multiPaymentToggle" name="togglemultiPayment">
            <span class="checkbox-text">¿Usa múltiples métodos?</span>
          </label>
        </div>
      </div>
    </div>

    <div class="payment-method-container">
      <!-- Modo simple -->
      <div id="singleMethodGroup">
        <select id="methodSimple" name="methodSimple">
          {% for method in methods %}
            <option value="{{ method.id }}">{{ method.nombre }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="amount_simple" id="amountSimple">
      </div>

      <!-- Membresia -->
      <div id="membresiaMethodGroup" style="display: none;">
        <div class="membresia-method-group">
          <input type="number" name="check_membresia" id="check_membresia" step="1" placeholder="Número de Membresía">
        </div>
      </div>

      <!-- Modo múltiple -->
      <div id="multiMethodGroup" style="display: none;">
        <div class="payment-method-group">
          <select name="method_multiple_1" id="method_multiple_1">
            {% for method in methods %}
              <option value="{{ method.id }}">{{ method.nombre }}</option>
            {% endfor %}
          </select>
          <input type="number" name="amount_method_multi_1" id="amount_method_multi-1" step="1" placeholder="Monto $">
        </div>

        <div class="payment-method-group">
          <select name="method_multiple_2" id="method_multiple_2">
            {% for method in methods %}
              <option value="{{ method.id }}">{{ method.nombre }}</option>
            {% endfor %}
          </select>
          <input type="number" name="amount_method_multi_2" id="amount_method_multi_2" step="1" placeholder="Monto $">
        </div>
      </div>
    </div>
    <p id="methodRepeatError" class="text-danger mt-1" style="display: none;">
      No puede elegir el mismo método de pago dos veces
    </p>
    <p id="montoError" class="text-danger mt-1" style="display: none;">
      La suma de los métodos de pago y la propina debe coincidir con el total a pagar
    </p>
    <p id="mensaje_error_membresia" class="text-danger mt-1" style="display: none;">
      Debe ingresar un número de membresía válido
    </p>

  </div>

  <!-- Propina -->
  <div class="form-group">
    <label for="tip">Propina y Total a Pagar:</label>
    <div class="propina-row">
      <input type="number" name="tip" id="tip" step="1" placeholder="$" class="form-control">
      <input type="text" name="totalPago" id="totalPago" placeholder="$" class="form-control" readonly>
      <button type="submit" class="btn-primary">Guardar pago</button>
    </div>
  </div>
</form>

<h3>Pagos Hoy</h3>

{% set contadores = namespace(cortes=0, productos=0) %}
{% set servicios_barbero = namespace(data={}) %}

<table class="table table-striped table-bordered text-center" style="margin-top: 1rem;">
  <thead>
    <tr>
      <th>Hora</th>
      <th>Barbero</th>
      <th>Servicio</th>
      <th>Producto</th>
      <th>Membresia</th>
      <th>M. Pago </th>
      <th>Monto</th>
      <!-- 
        <th>M. Pago</th> 
        <th>Monto</th> 
      -->
      <th>Propina</th>
      <th>Monto Total</th>
      <th>Borrar Pago</th>
    </tr>
  </thead>
  {% for pago in pagos %}
    <tr>
      <td>{{ pago.date.strftime('%H:%M') }}</td>
      <td>{{ pago.appointment.barber.name }}</td>
      <!-- <td>{{ pago.appointment.service.name if pago.appointment.service else '-' }}</td> -->
      <td>  <!-- Tipo de servicio -->
        {% if pago.appointment.service %}
          {% set contadores.cortes = contadores.cortes + 1 %}
          {% set barbero = pago.appointment.barber.name %}
          {% if barbero in servicios_barbero.data %}
            {% set _ = servicios_barbero.data.update({barbero: servicios_barbero.data[barbero] + 1}) %}
          {% else %}
            {% set _ = servicios_barbero.data.update({barbero: 1}) %}
          {% endif %}
          {% if pago.appointment.tipo_precio_servicio == 'amigo' %}
            Vale por {{ pago.appointment.service.name }} 
          {% elif pago.appointment.tipo_precio_servicio == 'descuento' %}
            {{ pago.appointment.service.name }} Descuento
          {% else %}
            {{ pago.appointment.service.name }}
          {% endif %}
        {% else %}
          -
        {% endif %}
      </td>
      <td>  <!-- Producto + Cantidad-->
        {% if pago.appointment.productos_turno %}
          {% set productos = {} %}
          {% for pt in pago.appointment.productos_turno %}
            {% set contadores.productos = contadores.productos + pt.cantidad %}
            {% set nombre = pt.producto.name %}
            {% if nombre in productos %}
              {% set _ = productos.update({nombre: productos[nombre] + pt.cantidad}) %}
            {% else %}
              {% set _ = productos.update({nombre: pt.cantidad}) %}
            {% endif %}
          {% endfor %}
          {% for nombre, cantidad in productos.items() %}
            {{ nombre }} x {{ cantidad }}{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          -
        {% endif %}
      </td>
      <!-- <td>{{ pago.appointment.membresia.id if pago.appointment.membresia else '-' }}</td>-->
      <td>
        {% if pago.appointment.membresia %}
          {% if not pago.membresia_comprada %}
            {{ pago.appointment.membresia.id_usuario }} (uso) 
          {% else %}
            {{ pago.appointment.membresia.id_usuario }}
          {% endif %}
        {% else %}
          -
        {% endif %}
      </td>
      <td> <!-- Métodos de pago -->
        {% if pago.method2 %}
          {{ pago.method1.nombre }} - {{ pago.method2.nombre }}
        {% elif pago.appointment.service %}
          {% if pago.appointment.tipo_precio_servicio == 'amigo' %}
            -
          {% else %}
            {{ pago.method1.nombre }}
          {% endif %}
        {% else %}
          {{ pago.method1.nombre }}
        {% endif %}
      </td>
      <td> <!-- Montos de pago -->
        {% if pago.appointment and pago.appointment.tipo_precio_servicio == 'amigo' %}
          $0
        {% elif pago.method2 %}
          ${{ "{:,.0f}".format(pago.amount_method1 or 0).replace(",", ".") }} - ${{ "{:,.0f}".format(pago.amount_method2 or 0).replace(",", ".") }}
        {% else %}
          ${{ "{:,.0f}".format((pago.amount_method1 or 0) - (pago.amount_tip or 0)).replace(",", ".") }}
        {% endif %}
      </td>      
      <td>${{ "{:,.0f}".format(pago.amount_tip)|replace(",", ".") }}</td>
      <td>
        {% if pago.appointment and pago.appointment.tipo_precio_servicio == 'amigo' %}
          $0
        {% else %}
          ${{ "{:,.0f}".format((pago.amount_method1 or 0) + (pago.amount_method2 or 0)) | replace(",", ".") }}
        {% endif %}
      </td>      
      <td class="borrar-pago">
        <form method="POST" action="{{ url_for('delete_payment', pago_id=pago.id) }}">
          <button type="submit" class="btn btn-danger" title="Eliminar">🗑️</button>
        </form>
      </td>
    </tr>
  {% endfor %}
</table>
<div class="linea-inferior"></div>
  <div style="margin-top: 1rem;">
  <strong>Total de cortes:</strong> {{ contadores.cortes }}<br>

  <div class="linea-inferior"></div>
  <strong>Cantidad de Cortes por barbero:</strong>
  <ul>
    {% for barbero, cantidad in servicios_barbero.data.items() %}
      <li>- {{ barbero }}: {{ cantidad }}</li>
    {% endfor %}
  </ul>


  <strong>Total de productos vendidos:</strong> {{ contadores.productos }}
  <div class="linea-inferior"></div>
</div>



<script>
  const serviceSelect = document.getElementById('serviceSelect');
  const servicePrice = document.getElementById('servicePrice');
  const togglemultiPayment = document.getElementById('multiPaymentToggle');   // cambiar al nombre de abajo
  const multiPaymentToggle = document.getElementById('multiPaymentToggle');
  const productToggle = document.getElementById('productToggle');
  const singleGroup = document.getElementById('singleMethodGroup');
  const multiGroup = document.getElementById('multiMethodGroup');
  const form = document.getElementById('paymentForm');
  const errorMsg = document.getElementById('multiPaymentError');
  const repeatError = document.getElementById('methodRepeatError');
  
  const amountSimple = document.getElementById('amountSimple');
  const method1Select = document.getElementById('method1');
  const method2Select = document.getElementById('method2');

  const servicioToggle = document.getElementById('toggleServicio');
  const productoToggle = document.getElementById('toggleProducto');
  const membresiaToggle = document.getElementById('toggleMembresia');

  const servicioSection = document.getElementById('servicioSection');
  const productSection = document.getElementById('productSection');
  const membresiaSelect = document.getElementById('membresiaSelect');
  const priceInput = document.getElementById('membreciaPrice');

  const membresiaLabel = document.getElementById('membresiaLabel');
  const membershipDiv = document.getElementById('membresiaMethodGroup');

  // checkboxs 
  const precioAmigoCheckbox = document.getElementById('precioAmigoCheckbox');
  const precioDescuentoCheckbox = document.getElementById('precioDescuentoCheckbox');
  const checkbox_use_member = document.getElementById('membresiaCheckbox');


  // Función para mostrar/ocultar secciones según el toggle (servicio/producto)
  /*
    function updateToggleSections(e = null) {
      const source = e?.target?.id || null;
      const membresiaCheckbox = document.getElementById('membresiaCheckbox');

      // Ocultar mensaje de error si estaba visible
      document.getElementById('messageContainer').style.display = 'none';

      // Si algún toggle está seleccionado, ocultar el mensaje de error
      if (servicioToggle.checked || productoToggle.checked || membresiaToggle.checked) {
        mostrarErrorToggle(false);
      }

      if (source === 'toggleMembresia' && membresiaToggle.checked) {
        // Si el usuario activó membresía, desactiva los otros
        servicioToggle.checked = false;
        productoToggle.checked = false;
        // Desmarcar el checkbox de usa membresía si estaba marcado
        if (membresiaCheckbox) {
          membresiaCheckbox.checked = false;
          multiMethodGroup.style.display = 'none';
        
          // Disparar el evento change para actualizar la UI
          membresiaCheckbox.dispatchEvent(new Event('change'));
        }
      }

      if ((source === 'toggleServicio' && servicioToggle.checked) || 
          (source === 'toggleProducto' && productoToggle.checked)) {
        // Si el usuario activó servicio o producto, desactiva membresía
        membresiaToggle.checked = false;
        // Si el checkbox de usa membresía estaba marcado, habilitar múltiples métodos
        if (membresiaCheckbox && membresiaCheckbox.checked) {
          membresiaCheckbox.checked = false;
          if (multiPaymentToggle) {
            multiPaymentToggle.disabled = false;
          }
          // Disparar el evento change para actualizar la UI
          membresiaCheckbox.dispatchEvent(new Event('change'));
        }
      }

      // Mostrar u ocultar secciones 
      servicioSection.style.display = servicioToggle.checked ? 'block' : 'none';
      productSection.style.display = productoToggle.checked ? 'block' : 'none';
      membresiaSection.style.display = membresiaToggle.checked ? 'block' : 'none';
      membresiaLabel.style.display = membresiaToggle.checked ? 'none' : 'block';

      if (productoToggle.checked) {
        const productSelect = document.querySelector('.productSelect');
        if (productSelect) {
          updateCantidadOptions(productSelect);
        }
        initProductSection(); 
      }

      if (membresiaToggle.checked) {
        initMembresiaSection();
      }
      
      resetTip();
      updatePriceTotal();
    }
  */
  function updateToggleSections(e = null) {
    const source = e?.target?.id || null;
    const membresiaCheckbox = document.getElementById('membresiaCheckbox');

    // Ocultar mensaje de error si estaba visible
    document.getElementById('messageContainer').style.display = 'none';

    // Si algún toggle está seleccionado, ocultar el mensaje de error
    if (servicioToggle.checked || productoToggle.checked || membresiaToggle.checked) {
      mostrarErrorToggle(false);
    }

    if (source === 'toggleMembresia' && membresiaToggle.checked) {
      // Si el usuario activó membresía, desactiva los otros
      servicioToggle.checked = false;
      productoToggle.checked = false;
      membresiaLabel.style.display = 'none';

      // Desmarcar el checkbox de usa membresía si estaba marcado
      if (membresiaCheckbox) {
        membresiaCheckbox.checked = false;
        multiMethodGroup.style.display = 'none';
      
        // Disparar el evento change para actualizar la UI
        membresiaCheckbox.dispatchEvent(new Event('change'));
      }
    }

    if (source === 'toggleServicio' && servicioToggle.checked) {
      // Si el usuario activó servicio desactiva membresía y producto
      membresiaToggle.checked = false;
      productoToggle.checked = false;
      membresiaLabel.style.display = 'block';
      // Si el checkbox de usa membresía estaba marcado, habilitar múltiples métodos
      if (membresiaCheckbox && membresiaCheckbox.checked) {
        membresiaCheckbox.checked = false;
        if (multiPaymentToggle) {
          multiPaymentToggle.disabled = false;
        }
        // Disparar el evento change para actualizar la UI
        membresiaCheckbox.dispatchEvent(new Event('change'));
      }
    }

    if (source === 'toggleProducto' && productoToggle.checked) {
      // Si el usuario activó producto, desactiva membresía y servicio
      servicioToggle.checked = false;
      membresiaToggle.checked = false;
      membresiaLabel.style.display = 'none';
      // Si el checkbox de usa membresía estaba marcado, habilitar múltiples métodos
      if (membresiaCheckbox && membresiaCheckbox.checked) {
        membresiaCheckbox.checked = false;
        if (multiPaymentToggle) {
          multiPaymentToggle.disabled = false;
        }
        // Disparar el evento change para actualizar la UI
        membresiaCheckbox.dispatchEvent(new Event('change'));
      }
    }

    // Mostrar u ocultar secciones 
    servicioSection.style.display = servicioToggle.checked ? 'block' : 'none';
    productSection.style.display = productoToggle.checked ? 'block' : 'none';
    membresiaSection.style.display = membresiaToggle.checked ? 'block' : 'none';
    // 

    if (productoToggle.checked) {
      const productSelect = document.querySelector('.productSelect');
      if (productSelect) {
        updateCantidadOptions(productSelect);
      }
      initProductSection(); 
    }

    if (membresiaToggle.checked) {
      initMembresiaSection();
    }
    
    resetTip();
    updatePriceTotal();
  }


  // Listeners que actualizan la visibilidad si el usuario cambia de opción
  servicioToggle.addEventListener('change', updateToggleSections);
  productoToggle.addEventListener('change', updateToggleSections);
  membresiaToggle.addEventListener('change', updateToggleSections);

  // Actualiza dinámicamente las opciones de cantidad según el producto seleccionado
  function updateCantidadOptions(selectElement) {
    const row = selectElement.closest('.productRow');
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const cantidadDisponible = parseInt(selectedOption.dataset.cantidad || 0);

    const cantidadSelect = row.querySelector('.productCant');
    cantidadSelect.innerHTML = ''; // Limpiar opciones previas

    const maxCantidad = Math.min(10, cantidadDisponible);

    for (let i = 1; i <= maxCantidad; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      cantidadSelect.appendChild(option);
    }

    // Actualizar el precio después de cambiar las opciones de cantidad
    updatePrice(row);
  }

  function resetTip() {
    const tipInput = document.getElementById('tip');
    tipInput.value = 0;
    updatePriceTotal(); // Actualiza el total sin la propina
  }

  // Funciones que actualizan el precio del servicio seleccionado y lo asigna al input de solo lectura y a propina
  function obtenerPrecioServicioSeleccionado() {
    const usaMembresia = document.getElementById('membresiaCheckbox')?.checked || false;
    const membresiaActivo = membresiaToggle.checked;

    // Si está usando un corte de membresía, el precio es 0
    if (membresiaActivo && usaMembresia) {
      return 0;
    }

    const selected = serviceSelect.options[serviceSelect.selectedIndex];
    if (!selected) return 0;

    if (precioDescuentoCheckbox.checked) {
      return parseFloat(selected.getAttribute('data-precio-descuento')) || 0;
    } else if (precioAmigoCheckbox.checked) {
      return parseFloat(selected.getAttribute('data-precio-amigo')) || 0;
    }

    return parseFloat(selected.getAttribute('data-precio')) || 0;
  }

  function updatePrice() {
    const precio = obtenerPrecioServicioSeleccionado();
    const precioRedondeado = Math.round(precio);

    // Formatear con separador de miles y símbolo $
    // const precioFormateado = `$${precioRedondeado.toLocaleString('es-ES')}`;
    const precioFormateado = formatearMoneda(precio);

    // Asignar valores al input visible y al oculto
    servicePrice.value = precioFormateado;
    amountSimple.value = precioRedondeado; // Este mantiene el valor numérico sin formato
  }

  function updatePriceTotal() {
    let precioTotal = 0;

    const servicioActivo = servicioToggle.checked;
    const productoActivo = productoToggle.checked;
    const membresiaActivo = membresiaToggle.checked;
    const usaMembresia = document.getElementById('membresiaCheckbox')?.checked || false;
    
    if (membresiaActivo) {
      /*
        if (usaMembresia) {
          // Si está usando un corte de membresía, el precio es 0
          precioTotal = 0;
        } else {
          // Si está comprando una membresía nueva
          precioTotal = obtenerPrecioMembresia();
        }
      */
      precioTotal = obtenerPrecioMembresia();
    } else {
      if (servicioActivo) {
        if (usaMembresia) {
          // Si está usando un corte de membresía, el precio es 0
          precioTotal = 0;
        } else {
          precioTotal += obtenerPrecioServicioSeleccionado();
        }
      }

      if (productoActivo) {
        const productosData = obtenerProductosSeleccionados();
        precioTotal += productosData.total;
      }
    }

    updatePrice(); // Aseguramos que el precio del servicio esté actualizado
    
    const tipAmount = parseFloat(document.getElementById('tip').value) || 0;
    const totalConPropina = precioTotal + tipAmount;

    document.getElementById('totalPago').value = formatearMoneda(totalConPropina);
  }


  // Oculta alertas automáticamente después de 15 segundos
  setTimeout(() => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      alert.classList.remove('show');
      alert.classList.add('fade');
      setTimeout(() => alert.remove(), 1000);
    });
  }, 15000);

  // Evento para alternar entre modo de pago simple y múltiple
  togglemultiPayment.addEventListener('change', function () {
    const paymentMethodsGroup = document.querySelector('.form-group.payment-methods');

    // Al entrar a esta función, desactivar la membresía si estaba activa
    if (checkbox_use_member.checked) {
      checkbox_use_member.checked = false;
      membershipDiv.style.display = 'none';
      servicioSection.style.display = 'block';
      updatePriceTotal();

      // checkbox_use_member.dispatchEvent(new Event('change'));
    }
    
    if (this.checked) {
      // Si se activa el pago múltiple, ocultar el modo simple y mostrar campos adicionales
      singleGroup.style.display = 'none';
      multiGroup.style.display = 'block';
      multiGroup.querySelectorAll('input').forEach(el => el.required = true);
      paymentMethodsGroup.classList.add('multiple');
    } else {
      // Si se desactiva, volver al modo simple
      singleGroup.style.display = 'flex';
      multiGroup.style.display = 'none';
      multiGroup.querySelectorAll('input').forEach(el => {
        el.required = false;
        el.classList.remove('input-error');
      });
      multiGroup.querySelectorAll('select').forEach(el => el.classList.remove('input-error'));
      errorMsg.style.display = 'none';
      repeatError.style.display = 'none';
      paymentMethodsGroup.classList.remove('multiple');
    }
  });


  /// Funciones utilizadas en submit

  function mostrarErrorToggle(mostrar) {
    toggleError.style.display = mostrar ? 'block' : 'none';
    toggleContainer.classList.toggle('border', mostrar);
    toggleContainer.classList.toggle('border-danger', mostrar);
    toggleContainer.classList.toggle('rounded', mostrar);
    toggleContainer.classList.toggle('p-2', mostrar);
  }

  function obtenerPrecioServicio() {
    const precio = obtenerPrecioServicioSeleccionado();
    // const precioRedondeado = Math.round(precio);
    // return parseFloat(precioRedondeado) ;
    return formatearMoneda(precio);
  }

  function obtenerPrecioMembresia() {
    const input = document.getElementById('membreciaPrice');
    // const valor = input.value.replace('$', '').trim();
    const valor = input.value.replace(/\./g, '').replace('$', '').trim();
    return parseFloat(valor) || 0;
  }


  function obtenerProductosSeleccionados() {
    const rows = document.querySelectorAll('#productSection .productRow');
    const items = [];
    let total = 0;

    rows.forEach((row) => {
      const productSelect = row.querySelector('.productSelect');
      const cantidadSelect = row.querySelector('.productCant');

      if (!productSelect || !cantidadSelect) return;

      const selected = productSelect.options[productSelect.selectedIndex];
      const id = selected.value;
      const precio = parseFloat(selected.getAttribute('data-precio')) || 0;
      const cantidad = parseInt(cantidadSelect.value) || 0;

      if (cantidad > 0) {
        items.push({ id, precio, cantidad });
        total += precio * cantidad;
      }
    });

    return { total, items };
  }

  function agregarInputsOcultos(productos) {
    productos.forEach((producto, index) => {
      const inputId = crearInputOculto(`product_id_${index}`, producto.id);
      const inputCant = crearInputOculto(`cantidad_${index}`, producto.cantidad);
      form.appendChild(inputId);
      form.appendChild(inputCant);
    });
  }

  function crearInputOculto(nombre, valor) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = nombre;
    input.value = valor;
    return input;
  }

  function validarMultiplesMetodos(totalEsperado) {
    const form = document.querySelector('form');
    const repeatError = document.getElementById('methodRepeatError');
    const montoError = document.getElementById('montoError');

    const amount1 = parseFloat(form.querySelector('input[name="amount_method_multi_1"]').value) || 0;
    const amount2 = parseFloat(form.querySelector('input[name="amount_method_multi_2"]').value) || 0;
    const propina = parseFloat(form.querySelector('input[name="tip"]').value) || 0;
    const totalPagado = amount1 + amount2;

    const method1 = form.querySelector('select[name="method_multiple_1"]').value;
    const method2 = form.querySelector('select[name="method_multiple_2"]').value;

    const metodoInputs = [
      form.querySelector('select[name="method_multiple_1"]'),
      form.querySelector('select[name="method_multiple_2"]')
    ];

    const montoInputs = [
      form.querySelector('input[name="amount_method_multi_1"]'),
      form.querySelector('input[name="amount_method_multi_2"]'),
      form.querySelector('input[name="tip"]')
    ];

    // Ocultar mensajes de error inicialmente
    repeatError.style.display = 'none';
    montoError.style.display = 'none';
    metodoInputs.forEach(select => select.classList.remove('input-error'));
    montoInputs.forEach(input => input.classList.remove('input-error'));

    // Validar métodos repetidos
    if (method1 === method2) {
      metodoInputs.forEach(select => select.classList.add('input-error'));
      repeatError.style.display = 'block';
      return false;
    }

    // Validar que el total pagado sea correcto
    // console.log("totalPagado: ",totalPagado)
    // console.log("totalEsperado: ",totalEsperado)
    // console.log("propina: ",propina)
    // console.log("totalEsperado + propina: ",totalEsperado + propina)
    // console.log("totalPagado - totalEsperado + propina: ",totalPagado - totalEsperado + propina)
    if (Math.abs(totalPagado - totalEsperado - propina) > 0.01) {
      montoInputs.forEach(input => input.classList.add('input-error'));
      montoError.style.display = 'block';
      return false;
    }

    return true;
  }


  // Validaciones al enviar el formulario
  // Validar que haga las mismas validaciones que func python
  form.addEventListener('submit', function (e) {
    // Siempre prevenir el envío por defecto primero
    e.preventDefault();
    
    let valid = true;

    const toggleError = document.getElementById('toggleError');
    const toggleContainer = document.getElementById('toggleContainer');

    const servicioActivo = servicioToggle.checked;
    const productoActivo = productoToggle.checked;
    const membresiaActivo = membresiaToggle.checked;

    // Validar toggles
    if (!servicioActivo && !productoActivo && !membresiaActivo) {
      mostrarErrorToggle(true);
      return;
    }
    mostrarErrorToggle(false);

    if (servicioActivo || productoActivo) {   // arreglar 
      const servicePrecio = servicioActivo ? obtenerPrecioServicio() : 0;
      
      const productosData = productoActivo ? obtenerProductosSeleccionados() : { total: 0, items: [] };

      if (productoActivo && productosData.items.length === 0) {
        alert('Debe seleccionar al menos un producto con cantidad válida');
        return;
      }

      let membresiaValue = parseInt(document.getElementById("check_membresia").value);
      let campo = document.getElementById("check_membresia");
      let mensaje = document.getElementById("mensaje_error_membresia");

      if (servicioActivo && checkbox_use_member.checked) {
        console.log("checkbox_use_member:",checkbox_use_member.checked);
        if (!membresiaValue) {
          mostrarError(campo, mensaje);
          return;
        } 
      }

      agregarInputsOcultos(productosData.items);

      let servicePrecio_num = servicePrecio.toString().replace('$', '').replace(/\./g, '');
      servicePrecio_num = parseFloat(servicePrecio_num);

      let productosData_num = String(productosData.total).replace('$', '').replace(/\./g, '');
      productosData_num = parseFloat(productosData_num);

      const totalEsperado = servicePrecio_num + productosData_num;

      // console.log("servicePrecio: ",servicePrecio_num)
      // console.log("productosData.total: ",productosData_num)
      // console.log("totalEsperado: ",totalEsperado)

      if (togglemultiPayment.checked && !validarMultiplesMetodos(totalEsperado)) {
        return;
      }
    }

    if (membresiaActivo) {
      const usa_membresia = document.getElementById('membresiaCheckbox');
        
      if (!usa_membresia.checked) {
        const precioActual = obtenerPrecioMembresia();
        const totalEsperado = precioActual;

        if (togglemultiPayment.checked && !validarMultiplesMetodos(totalEsperado)) {
          return;
        }
      }
    }

    // Si llega aca, todo es válido
    e.target.submit();
  });


  // Limpia el error de validación en los inputs de monto al modificarlos
  document.querySelectorAll('input[name="amount1"], input[name="amount2"]').forEach(input => {
    input.addEventListener('input', () => {
      input.classList.remove('input-error');
      errorMsg.style.display = 'none';
    });
  });

  // Limpia el error si se corrige la selección de métodos de pago
  document.querySelectorAll('select[name="method1"], select[name="method2"]').forEach(select => {
    select.addEventListener('change', () => {
      select.classList.remove('input-error');
      repeatError.style.display = 'none';
    });
  });

  // Inicial
  updateToggleSections();   // Inicializa visibilidad de secciones al cargar el script

  function formatearMoneda(valor) {
    const numero = Math.round(Number(valor));
    return `$${numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
  }
 
  function mostrarError(campo, mensaje) {
    campo.classList.add('input-error');
    mensaje.style.display = 'block';
  }

  function ocultarError(campo, mensaje) {
    campo.classList.remove('input-error');
    mensaje.style.display = 'none';
  }

  // Muestra/oculta los métodos de pago según si está marcada la membresía
  function initMembresiaSection() {
    const membresiaSelect = document.getElementById('membresiaSelect');
    const priceInput = document.getElementById('membreciaPrice');
    // const checkbox_use_member = document.getElementById('membresiaCheckbox');

    function updateMembresiaPrice() {
      const selectedOption = membresiaSelect.options[membresiaSelect.selectedIndex];
      const precio = selectedOption.getAttribute('data-precio');

      multiGroup.querySelectorAll('input').forEach(el => {
        el.required = false;
        el.classList.remove('input-error');
      });
      multiGroup.querySelectorAll('select').forEach(el => el.classList.remove('input-error'));
      
      if (checkbox_use_member && checkbox_use_member.checked) {
        // Si está usando un corte de membresía, mostrar precio en 0
        priceInput.value = '$0';
      } else {
        // Si está comprando una membresía nueva, mostrar precio normal
        // priceInput.value = precio ? `$${parseFloat(precio).toFixed(0)}` : '';
        priceInput.value = precio ? formatearMoneda(precio) : '';
      }
      updatePriceTotal();
    }

    if (!membresiaSelect.dataset.listenerAdded) {
      membresiaSelect.addEventListener('change', updateMembresiaPrice);
      membresiaSelect.dataset.listenerAdded = "true";
    }

    if (checkbox_use_member && !checkbox_use_member.dataset.listenerAdded) {
      checkbox_use_member.addEventListener('change', updateMembresiaPrice);
      checkbox_use_member.dataset.listenerAdded = "true";
    }

    // Forzar actualización inicial
    updateMembresiaPrice();
  }

  function setupMembresiaCheckboxToggle() {
    const multiPaymentToggle = document.getElementById('multiPaymentToggle');
    const singleMethodGroup = document.getElementById('singleMethodGroup');
    const multiMethodGroup = document.getElementById('multiMethodGroup');
    const membresiaSection = document.getElementById('membresiaSection');

    if (!checkbox_use_member || !membershipDiv || !multiPaymentToggle || !singleMethodGroup) {
      console.warn("❌ Uno o más elementos no se encontraron.");
      return;
    }

    function actualizarPrecioServicio() {
      const servicePriceInput = document.getElementById('servicePrice');
      if (!servicePriceInput) return;

      if (checkbox_use_member.checked) {
        servicePriceInput.value = '$0';
        if (amountSimple) amountSimple.value = 0;
        multiPaymentToggle.disabled = false;

      } else {
        // updatePrice();
      }
      //updatePriceTotal();
    }


    checkbox_use_member.addEventListener('change', function () {

      if (togglemultiPayment.checked){
        togglemultiPayment.checked = false; 
      }

      if (checkbox_use_member.checked) {

        servicioSection.style.display = 'none';
        membershipDiv.style.display = 'block';
        singleMethodGroup.style.display = 'none';
        multiMethodGroup.style.display = 'none';

      } else {
        servicioSection.style.display = 'block';
        membershipDiv.style.display = 'none';
        singleMethodGroup.style.display = 'block';

        if (multiPaymentToggle.checked) {
          multiMethodGroup.style.display = 'block';
          singleGroup.style.display = 'none';
        }

      }
      actualizarPrecioServicio();
      
    });
  
    // Asegurarse de que el precio esté correcto al cargar
    actualizarPrecioServicio();
  }

  // Asegurarse de que el precio se actualice cuando cambia el servicio seleccionado
  serviceSelect.addEventListener('change', function() {
    const checkbox_use_member = document.getElementById('membresiaCheckbox');
    if (checkbox_use_member && checkbox_use_member.checked) {
      const servicePriceInput = document.getElementById('servicePrice');
      if (servicePriceInput) {
        servicePriceInput.value = '$0';
        if (amountSimple) amountSimple.value = 0;
      }
    } else {
      updatePrice();
    }
    updatePriceTotal();
  });

  // init toggle servicios
  function initServicesSection() {
    // Cuando se selecciona "precio amigo", desmarca "precio descuento"
    precioAmigoCheckbox.addEventListener('change', function () {
      if (this.checked) {
        precioDescuentoCheckbox.checked = false;
      }
    });

    // Cuando se selecciona "precio descuento", desmarca "precio amigo"
    precioDescuentoCheckbox.addEventListener('change', function () {
      if (this.checked) {
        precioAmigoCheckbox.checked = false;
      }
    });

    document.addEventListener('DOMContentLoaded', updatePrice);

    updatePrice();                                            // Se llama una vez al cargar la página para mostrar el precio inicial
    serviceSelect.addEventListener('change', updatePriceTotal);    // Actualiza el precio cada vez que se cambia el servicio seleccionado
    precioAmigoCheckbox.addEventListener('change', updatePriceTotal);
    precioDescuentoCheckbox.addEventListener('change', updatePriceTotal);
    updatePriceTotal();
  }

  // Init toggle producto
  function initProductSection() {
    const productSection = document.getElementById('productSection');

    function updatePrice(row) {
      const precio = parseFloat(row.querySelector('.productSelect').selectedOptions[0].dataset.precio || 0);
      const cantidad = parseInt(row.querySelector('.productCant').value || 1);
      const total = precio * cantidad;
      // row.querySelector('.productPrice').value = `$${Math.round(total)}`;
      row.querySelector('.productPrice').value = formatearMoneda(total);
      updatePriceTotal();
    }

    if (!productSection.dataset.listenersAdded) {
      // Agregar producto
      productSection.addEventListener('click', function (e) {
        if (e.target.classList.contains('addProductBtn')) {
          const currentRow = e.target.closest('.productRow');
          const newRow = currentRow.cloneNode(true);

          newRow.querySelector('.productSelect').setAttribute('name', 'product_id[]');
          newRow.querySelector('.productCant').setAttribute('name', 'product_quantity[]');

          newRow.querySelector('.productSelect').selectedIndex = 0;
          newRow.querySelector('.productCant').selectedIndex = 0;
          newRow.querySelector('.productPrice').value = '';
          productSection.appendChild(newRow);

          updatePrice(newRow);

          const messageContainer = document.getElementById('messageContainer');
          messageContainer.style.display = 'none';
          messageContainer.textContent = '';
        }

        // Eliminar producto
        if (e.target.classList.contains('removeProductBtn')) {
          const row = e.target.closest('.productRow');
          const rows = productSection.querySelectorAll('.productRow');
          const messageContainer = document.getElementById('messageContainer');

          if (rows.length > 1) {
            row.remove();
            updatePriceTotal();
            messageContainer.style.display = 'none';
            messageContainer.textContent = '';
          } else {
            messageContainer.style.display = 'block';
            messageContainer.textContent = 'Debe haber al menos un producto.';
          }
        }
      });

      // Recalcular precios
      productSection.addEventListener('change', function (e) {
        if (e.target.classList.contains('productSelect') || e.target.classList.contains('productCant')) {
          const row = e.target.closest('.productRow');
          updatePrice(row);
        }
      });

      productSection.dataset.listenersAdded = "true";
    }

    // Calcular precio inicial
    document.querySelectorAll('.productRow').forEach(row => {
      updatePrice(row);
    });

    updatePriceTotal();
  }

  document.addEventListener('DOMContentLoaded', function () {
    initServicesSection();
    initProductSection();
    initMembresiaSection();
    setupMembresiaCheckboxToggle();
    updatePriceTotal();
  });

  // Agregar event listener para el input de propina
  document.getElementById('tip').addEventListener('input', updatePriceTotal);

</script>

{% endblock %}
